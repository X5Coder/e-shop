// Open Book Details (Redirect to pay.html with book ID)
function openBookDetails(bookId) {
    // Check if user has already purchased this book
    const userId = localStorage.getItem('userId') || generateUserId();
    const purchaseKey = `purchased_${bookId}`;
    
    database.ref('orders').orderByChild('bookId').equalTo(bookId).once('value')
        .then((snapshot) => {
            if (snapshot.exists()) {
                const orders = snapshot.val();
                const userOrder = Object.values(orders).find(order => 
                    order.userEmail === localStorage.getItem('userEmail') && order.status === 'completed'
                );
                
                if (userOrder) {
                    // User already purchased - show download button
                    showDownloadModal(bookId, userOrder.downloadLink);
                } else {
                    // Redirect to payment page
                    window.location.href = `pay.html?book=${bookId}`;
                }
            } else {
                // Redirect to payment page
                window.location.href = `pay.html?book=${bookId}`;
            }
        })
        .catch(() => {
            window.location.href = `pay.html?book=${bookId}`;
        });
}

// Show download modal
function showDownloadModal(bookId, downloadLink) {
    const modalHTML = `
        <div class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
            <div class="bg-gray-900 rounded-2xl p-6 max-w-md w-full border border-gray-700">
                <div class="text-center mb-6">
                    <div class="w-16 h-16 bg-green-600/20 rounded-full flex items-center justify-center mx-auto mb-4 border-2 border-green-500/30">
                        <i class="fas fa-check text-green-500 text-2xl"></i>
                    </div>
                    <h3 class="text-xl font-bold mb-2">لقد اشتريت هذا الكتاب مسبقاً</h3>
                    <p class="text-gray-400">يمكنك تحميله الآن مجاناً</p>
                </div>
                
                <button onclick="window.open('${downloadLink}', '_blank')" 
                        class="w-full p-4 rounded-xl bg-green-600 hover:bg-green-700 transition-all font-bold mb-3">
                    <i class="fas fa-download mr-2"></i>تحميل الكتاب
                </button>
                
                <button onclick="closeModal()" 
                        class="w-full p-4 rounded-xl bg-white/5 hover:bg-white/10 transition-all">
                    إغلاق
                </button>
            </div>
        </div>
    `;
    
    const modal = document.createElement('div');
    modal.id = 'download-modal';
    modal.innerHTML = modalHTML;
    document.body.appendChild(modal);
}

function closeModal() {
    const modal = document.getElementById('download-modal');
    if (modal) modal.remove();
}

function generateUserId() {
    const userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2);
    localStorage.setItem('userId', userId);
    return userId;
}

// Update book button based on purchase status
function updateBookButton(bookId, buttonElement) {
    // Check purchase status from Firebase
    database.ref('orders').orderByChild('bookId').equalTo(bookId).once('value')
        .then((snapshot) => {
            if (snapshot.exists()) {
                const orders = snapshot.val();
                const userEmail = localStorage.getItem('userEmail');
                
                if (userEmail) {
                    const userOrder = Object.values(orders).find(order => 
                        order.userEmail === userEmail && order.status === 'completed'
                    );
                    
                    if (userOrder) {
                        // Change button to download
                        buttonElement.innerHTML = `
                            <button onclick="showDownloadModal('${bookId}', '${userOrder.downloadLink || '#'}')" 
                                    class="btn-press px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-xl text-sm font-bold active:scale-95 transition-all">
                                <i class="fas fa-download mr-2"></i>تحميل الكتاب
                            </button>
                        `;
                    }
                }
            }
        });
}
