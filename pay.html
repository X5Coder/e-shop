<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>E-Shop Pro | Ø§ÙƒÙ…Ø§Ù„ Ø§Ù„Ø´Ø±Ø§Ø¡</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        :root {
            --primary: #0066cc;
            --secondary: #cc3333;
            --bg-dark: #0a0a0a;
            --text-dark: #f5f5f5;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-dark);
            min-height: 100vh;
        }

        .glass {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .step-line {
            width: 60px;
            height: 2px;
            background: rgba(255, 255, 255, 0.1);
        }

        .step.active .step-circle {
            background: var(--primary);
            color: white;
        }

        .step.completed .step-circle {
            background: var(--success);
            color: white;
        }

        .step.pending .step-circle {
            background: rgba(255, 255, 255, 0.1);
            color: #999;
        }

        .step-label {
            font-size: 12px;
            color: #999;
        }

        .step.active .step-label {
            color: var(--primary);
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .status-tdd {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .status-ok {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .status-no {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .copy-btn {
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .copy-btn:hover {
            opacity: 0.8;
            transform: scale(1.05);
        }

        .copy-btn.copied {
            background: var(--success) !important;
        }

        .countdown-timer {
            font-family: monospace;
            font-size: 1.2em;
            color: var(--primary);
            font-weight: bold;
        }

        .payment-info-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            border-left: 4px solid var(--primary);
        }

        .payment-method-card {
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .payment-method-card:hover {
            border-color: var(--primary);
            background: rgba(0, 102, 204, 0.1);
        }

        .payment-method-card.selected {
            border-color: var(--primary);
            background: rgba(0, 102, 204, 0.15);
        }

        .payment-number {
            font-family: monospace;
            font-size: 1.1em;
            letter-spacing: 1px;
            background: rgba(255, 255, 255, 0.05);
            padding: 8px 12px;
            border-radius: 8px;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .transfer-flow {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
            position: relative;
        }

        .transfer-flow::before {
            content: "";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60%;
            height: 2px;
            background: var(--primary);
            opacity: 0.3;
        }

        .transfer-arrow {
            color: var(--primary);
            font-size: 1.5em;
            z-index: 1;
            background: var(--bg-dark);
            padding: 0 10px;
        }

        .history-card {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border-right: 4px solid transparent;
        }

        .history-card.tdd {
            border-right-color: var(--warning);
        }

        .history-card.ok {
            border-right-color: var(--success);
        }

        .history-card.no {
            border-right-color: var(--error);
        }

        .book-image-small {
            width: 60px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
        }

        .hidden-section {
            display: none;
        }

        .visible-section {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            z-index: 1000;
            animation: slideIn 0.3s ease;
            max-width: 400px;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .notification.success {
            background: var(--success);
        }

        .notification.error {
            background: var(--error);
        }

        .notification.info {
            background: var(--primary);
        }

        .fade-out {
            animation: fadeOut 0.3s ease forwards;
        }

        @keyframes fadeOut {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(100%); }
        }

        .user-email-badge {
            background: rgba(0, 102, 204, 0.1);
            border: 1px solid rgba(0, 102, 204, 0.3);
            border-radius: 20px;
            padding: 4px 12px;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .payment-details-table {
            width: 100%;
            border-collapse: collapse;
        }

        .payment-details-table td {
            padding: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .payment-details-table td:first-child {
            color: #999;
            width: 40%;
        }

        .payment-details-table td:last-child {
            font-weight: bold;
        }

        .purchase-stats {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
        }

        .stat-label {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }

        .final-section {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        @media (min-width: 768px) {
            .final-section {
                grid-template-columns: 1fr 1fr;
            }
        }

        .order-card {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .order-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .order-number {
            font-family: monospace;
            font-weight: bold;
            color: var(--primary);
        }

        .download-btn {
            background: linear-gradient(135deg, var(--success), #0da36b);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="glass px-4 py-3 flex items-center gap-3 sticky top-0 z-50">
        <button onclick="window.history.back()" class="w-10 h-10 flex items-center justify-center rounded-2xl bg-white/5 hover:bg-white/10 transition-all">
            <i class="fas fa-arrow-right text-white"></i>
        </button>
        <h1 class="text-xl font-bold flex-1">Ø§ÙƒÙ…Ø§Ù„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø´Ø±Ø§Ø¡</h1>
        <div id="user-email-badge" class="user-email-badge hidden">
            <i class="fas fa-user"></i>
            <span id="user-email-display">user@email.com</span>
        </div>
    </header>

    <!-- Main Content -->
    <main class="p-4 max-w-4xl mx-auto pb-20" id="main-content">
        <!-- Auto Check Section -->
        <section id="section-auto-check" class="visible-section">
            <div class="glass rounded-2xl p-6 text-center">
                <div class="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-6"></div>
                <h2 class="text-xl font-bold mb-4">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø´Ø±Ø§Ø¡...</h2>
                <p class="text-gray-400">ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø­Ø³Ø§Ø¨Ùƒ ÙˆØ§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</p>
            </div>
        </section>

        <!-- Step 1: Payment Method -->
        <section id="section-payment-method" class="hidden-section">
            <div class="step-indicator">
                <div class="step active">
                    <div class="step-circle">1</div>
                    <div class="step-label">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</div>
                </div>
                <div class="step-line"></div>
                <div class="step pending">
                    <div class="step-circle">2</div>
                    <div class="step-label">Ø§Ù„ØªØ£ÙƒÙŠØ¯</div>
                </div>
            </div>

            <!-- Book Info -->
            <div class="glass rounded-2xl p-4 mb-4">
                <div class="flex items-start gap-3">
                    <img id="book-preview-image" src="" alt="" class="book-image-small">
                    <div class="flex-1">
                        <h3 class="font-bold text-lg" id="book-preview-title">Ø§Ø³Ù… Ø§Ù„ÙƒØªØ§Ø¨</h3>
                        <div class="flex items-center gap-2 mt-1">
                            <span class="text-gray-400 line-through" id="book-old-price">0 Ø¬Ù†ÙŠÙ‡</span>
                            <span class="font-bold text-green-400 text-lg" id="book-preview-price">0 Ø¬Ù†ÙŠÙ‡</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="glass rounded-2xl p-6 mb-4">
                <div class="mb-6">
                    <div class="user-email-badge mx-auto mb-4">
                        <i class="fas fa-envelope"></i>
                        <span id="current-user-email">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
                    </div>
                    <h2 class="text-xl font-bold text-center">Ø§Ø®ØªØ± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</h2>
                </div>
                
                <div class="space-y-4">
                    <!-- Ù…Ø­ÙØ¸Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ© -->
                    <div class="payment-method-card" onclick="selectPaymentMethod('wallet')" id="wallet-card">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-blue-600/20 rounded-xl flex items-center justify-center">
                                <i class="fas fa-wallet text-blue-500 text-xl"></i>
                            </div>
                            <div class="flex-1">
                                <h3 class="font-bold">Ù…Ø­ÙØ¸Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©</h3>
                                <p class="text-sm text-gray-400">ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´ - Ø£ÙˆØ±Ù†Ø¬ ÙƒØ§Ø´ - ÙˆØºÙŠØ±Ù‡Ø§</p>
                            </div>
                            <div class="w-6 h-6 rounded-full border-2 border-gray-400 payment-check"></div>
                        </div>
                    </div>

                    <!-- PayPal -->
                    <div class="payment-method-card" onclick="selectPaymentMethod('paypal')" id="paypal-card">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-blue-900/20 rounded-xl flex items-center justify-center">
                                <i class="fab fa-paypal text-blue-400 text-xl"></i>
                            </div>
                            <div class="flex-1">
                                <h3 class="font-bold">PayPal</h3>
                                <p class="text-sm text-gray-400">Ø§Ù„Ø¯ÙØ¹ Ø¹Ø¨Ø± Ø­Ø³Ø§Ø¨ PayPal</p>
                            </div>
                            <div class="w-6 h-6 rounded-full border-2 border-gray-400 payment-check"></div>
                        </div>
                    </div>
                </div>

                <!-- Wallet Number Input -->
                <div id="wallet-number-input" class="mt-6 hidden">
                    <label class="block text-sm text-gray-400 mb-2">Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø© Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©</label>
                    <input type="tel" id="wallet-number" 
                           class="w-full p-3 bg-white/5 border border-white/10 rounded-xl focus:outline-none focus:border-blue-500 transition-all"
                           placeholder="Ù…Ø«Ø§Ù„: 01012345678"
                           maxlength="11"
                           pattern="01[0-9]{9}">
                    <p class="text-xs text-gray-500 mt-1">Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø© Ø§Ù„ØªÙŠ Ø³ØªÙ‚ÙˆÙ… Ø¨Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù…Ù†Ù‡Ø§ (11 Ø±Ù‚Ù…)</p>
                </div>

                <!-- PayPal Account Input -->
                <div id="paypal-account-input" class="mt-6 hidden">
                    <label class="block text-sm text-gray-400 mb-2">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙÙŠ PayPal</label>
                    <input type="text" id="paypal-account" 
                           class="w-full p-3 bg-white/5 border border-white/10 rounded-xl focus:outline-none focus:border-blue-500 transition-all"
                           placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
                </div>

                <button onclick="proceedToPaymentInstructions()" 
                        class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-bold mt-8 transition-all"
                        id="proceed-btn" disabled>
                    Ø§Ù„ØªØ§Ù„ÙŠ
                </button>
            </div>
        </section>

        <!-- Step 2: Payment Instructions -->
        <section id="section-payment-instructions" class="hidden-section">
            <div class="step-indicator">
                <div class="step completed">
                    <div class="step-circle"><i class="fas fa-check"></i></div>
                    <div class="step-label">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</div>
                </div>
                <div class="step-line"></div>
                <div class="step active">
                    <div class="step-circle">2</div>
                    <div class="step-label">Ø§Ù„ØªØ£ÙƒÙŠØ¯</div>
                </div>
            </div>

            <div class="glass rounded-2xl p-6 mb-4">
                <h2 class="text-xl font-bold mb-6 text-center">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯ÙØ¹</h2>
                
                <!-- Book Info -->
                <div class="mb-6 p-4 bg-white/5 rounded-xl">
                    <div class="flex items-start gap-3">
                        <img id="book-image" src="" alt="" class="book-image-small">
                        <div class="flex-1">
                            <h3 class="font-bold" id="book-title">Ø§Ø³Ù… Ø§Ù„ÙƒØªØ§Ø¨</h3>
                            <div class="flex justify-between items-center mt-2">
                                <span class="text-gray-400">Ø§Ù„Ø³Ø¹Ø±:</span>
                                <span class="font-bold text-blue-400 text-lg" id="book-price">0 Ø¬Ù†ÙŠÙ‡</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Payment Instructions -->
                <div id="wallet-instructions" class="payment-details">
                    <div class="payment-info-card">
                        <h3 class="font-bold mb-3">ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„ØªØ­ÙˆÙŠÙ„:</h3>
                        
                        <div class="space-y-4">
                            <div class="text-center">
                                <div class="text-sm text-gray-400 mb-2">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø°ÙŠ Ø³ÙŠØ±Ø³Ù„ <strong>Ù…Ù†Ù‡</strong></div>
                                <div class="payment-number text-lg">
                                    <span id="from-number">010XXXXXXXX</span>
                                    <button onclick="copyToClipboard('from')" class="copy-btn w-8 h-8 flex items-center justify-center bg-white/5 rounded-lg">
                                        <i class="fas fa-copy text-sm"></i>
                                    </button>
                                </div>
                            </div>

                            <div class="transfer-flow">
                                <div class="transfer-arrow"><i class="fas fa-long-arrow-alt-left fa-2x"></i></div>
                            </div>

                            <div class="text-center">
                                <div class="text-sm text-gray-400 mb-2">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø°ÙŠ Ø³ÙŠØ³ØªÙ‚Ø¨Ù„ <strong>(Ø«Ø§Ø¨Øª)</strong></div>
                                <div class="payment-number text-lg">
                                    <span id="to-number">01009341792</span>
                                    <button onclick="copyToClipboard('to')" class="copy-btn w-8 h-8 flex items-center justify-center bg-white/5 rounded-lg">
                                        <i class="fas fa-copy text-sm"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="mt-6 p-3 bg-blue-900/20 border border-blue-500/30 rounded-lg">
                            <p class="text-sm text-center">
                                <strong>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:</strong>
                                <span class="font-bold text-yellow-400 text-lg block mt-1" id="exact-amount">0 Ø¬Ù†ÙŠÙ‡</span>
                            </p>
                        </div>

                        <div class="mt-4 p-3 bg-yellow-900/20 border border-yellow-500/30 rounded-lg">
                            <p class="text-sm text-center">
                                <i class="fas fa-clock text-yellow-400 mr-2"></i>
                                <strong>Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± 15 Ø¯Ù‚ÙŠÙ‚Ø©</strong> Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
                            </p>
                        </div>
                    </div>
                </div>

                <!-- PayPal Instructions -->
                <div id="paypal-instructions" class="payment-details hidden">
                    <div class="payment-info-card">
                        <h3 class="font-bold mb-3">ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø¯ÙØ¹ Ø¹Ø¨Ø± PayPal:</h3>
                        
                        <div class="space-y-3">
                            <div>
                                <p class="text-sm text-gray-400 mb-2">Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø§Ø¨Ø· Ø£Ø¯Ù†Ø§Ù‡ Ù„Ù„Ø¯ÙØ¹ Ø¹Ø¨Ø± PayPal:</p>
                                <a href="https://paypal.me/eshope" 
                                   target="_blank"
                                   class="block p-3 bg-blue-900/20 border border-blue-500/30 rounded-lg text-center hover:bg-blue-900/30 transition-all">
                                    <i class="fab fa-paypal mr-2"></i>
                                    Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„Ù„Ø¯ÙØ¹ Ø¹Ø¨Ø± PayPal
                                </a>
                            </div>

                            <div class="mt-4 p-3 bg-yellow-900/20 border border-yellow-500/30 rounded-lg">
                                <p class="text-sm text-center">
                                    <i class="fas fa-clock text-yellow-400 mr-2"></i>
                                    <strong>Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± 15 Ø¯Ù‚ÙŠÙ‚Ø©</strong> Ø¨Ø¹Ø¯ Ø§Ù„Ø¯ÙØ¹ Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Countdown Timer -->
                <div class="mb-6 text-center">
                    <div class="inline-flex items-center gap-2 px-4 py-2 bg-white/5 rounded-xl">
                        <i class="fas fa-clock text-blue-400"></i>
                        <span class="text-sm text-gray-400">Ù…ØªØ¨Ù‚ÙŠ Ù„Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©:</span>
                        <span id="countdown" class="countdown-timer">15:00</span>
                    </div>
                    <p class="text-xs text-gray-400 mt-2">Ø³ÙŠØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ÙˆÙ‚Øª</p>
                </div>

                <!-- Confirm Button -->
                <div class="space-y-3">
                    <button onclick="confirmPayment()" 
                            class="w-full py-3 bg-green-600 hover:bg-green-700 text-white rounded-xl font-bold transition-all">
                        <i class="fas fa-check-circle mr-2"></i>
                        Ù…ÙˆØ§ÙÙ‚ - Ù‚Ù…Øª Ø¨Ø§Ù„ØªØ­ÙˆÙŠÙ„
                    </button>
                    
                    <button onclick="backToPaymentMethod()" 
                            class="w-full py-3 bg-white/5 hover:bg-white/10 rounded-xl font-bold transition-all">
                        Ø±Ø¬ÙˆØ¹
                    </button>
                </div>
            </div>
        </section>

        <!-- Final Section: Order Status & History -->
        <section id="section-final" class="hidden-section">
            <div class="final-section">
                <!-- Left Column: Order Status -->
                <div>
                    <div class="glass rounded-2xl p-6 mb-4">
                        <h2 class="text-xl font-bold mb-6 text-center">Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h2>
                        
                        <!-- Current Order Status -->
                        <div class="text-center mb-6">
                            <div id="status-icon" class="w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 border-4">
                                <i class="fas fa-clock text-3xl text-yellow-500"></i>
                            </div>
                            
                            <h3 id="status-title" class="text-lg font-bold mb-2">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</h3>
                            <p id="status-message" class="text-gray-400 mb-4">
                                ÙŠØªÙ… Ø­Ø§Ù„ÙŠØ§Ù‹ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ
                            </p>
                            
                            <div id="current-status-badge" class="inline-block">
                                <span class="status-badge status-tdd">
                                    <i class="fas fa-clock"></i> Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©
                                </span>
                            </div>
                        </div>

                        <!-- Order Details -->
                        <div class="mb-6">
                            <h4 class="font-bold mb-4 border-b border-white/10 pb-2">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø·Ù„Ø¨</h4>
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨:</span>
                                    <span id="current-order-id" class="font-mono font-bold">-</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</span>
                                    <span id="current-order-email" class="font-bold">-</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹:</span>
                                    <span id="current-payment-method" class="font-bold">-</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Ø§Ù„ØªØ§Ø±ÙŠØ®:</span>
                                    <span id="current-order-date" class="font-bold">-</span>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div id="action-buttons" class="space-y-3">
                            <button onclick="checkOrderStatus()" 
                                    class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-bold transition-all">
                                <i class="fas fa-sync-alt mr-2"></i>
                                ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©
                            </button>
                        </div>
                    </div>

                    <!-- Download Section (Shows when status is ok) -->
                    <div id="download-section" class="hidden">
                        <div class="glass rounded-2xl p-6 text-center">
                            <div class="w-16 h-16 bg-green-600/20 rounded-full flex items-center justify-center mx-auto mb-4 border-4 border-green-500/30">
                                <i class="fas fa-check-circle text-green-500 text-2xl"></i>
                            </div>
                            
                            <h3 class="text-lg font-bold mb-4">ØªÙ… Ø§Ù„Ø¯ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­! ğŸ‰</h3>
                            
                            <a id="download-link" href="#" target="_blank" 
                               class="download-btn w-full justify-center mb-4">
                                <i class="fas fa-download"></i>
                                ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒØªØ§Ø¨
                            </a>
                        </div>
                    </div>

                    <!-- Retry Section (Shows when status is no) -->
                    <div id="retry-section" class="hidden">
                        <div class="glass rounded-2xl p-6 text-center">
                            <div class="w-16 h-16 bg-red-600/20 rounded-full flex items-center justify-center mx-auto mb-4 border-4 border-red-500/30">
                                <i class="fas fa-times-circle text-red-500 text-2xl"></i>
                            </div>
                            
                            <h3 class="text-lg font-bold mb-4">ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø¯ÙØ¹</h3>
                            <p class="text-gray-400 mb-4">Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯ÙØ¹</p>
                            
                            <button onclick="retryPurchase()" 
                                    class="w-full py-3 bg-red-600 hover:bg-red-700 text-white rounded-xl font-bold transition-all">
                                <i class="fas fa-redo-alt mr-2"></i>
                                Ø´Ø±Ø§Ø¡ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Purchase History -->
                <div>
                    <div class="glass rounded-2xl p-6">
                        <h2 class="text-xl font-bold mb-6 text-center">Ø³Ø¬Ù„ Ø§Ù„Ø´Ø±Ø§Ø¡ Ù„Ù‡Ø°Ø§ Ø§Ù„ÙƒØªØ§Ø¨</h2>
                        
                        <!-- Statistics -->
                        <div class="mb-6">
                            <div class="purchase-stats">
                                <div class="stat-item">
                                    <div class="stat-value" id="history-total">0</div>
                                    <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value" id="history-ok">0</div>
                                    <div class="stat-label">Ù†Ø¬Ø§Ø­</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value" id="history-no">0</div>
                                    <div class="stat-label">ÙØ´Ù„</div>
                                </div>
                            </div>
                        </div>

                        <!-- Book Info -->
                        <div class="mb-6">
                            <div class="flex items-start gap-3">
                                <img id="history-book-image" src="" alt="" class="book-image-small">
                                <div class="flex-1">
                                    <h4 class="font-bold" id="history-book-title">Ø§Ø³Ù… Ø§Ù„ÙƒØªØ§Ø¨</h4>
                                    <p class="text-sm text-gray-400" id="history-book-description">ÙˆØµÙ Ø§Ù„ÙƒØªØ§Ø¨...</p>
                                    <div class="flex justify-between items-center mt-2">
                                        <span class="text-gray-400">Ø§Ù„Ø³Ø¹Ø±:</span>
                                        <span class="font-bold text-blue-400" id="history-book-price">0 Ø¬Ù†ÙŠÙ‡</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- History List -->
                        <div>
                            <h4 class="font-bold mb-4 border-b border-white/10 pb-2">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª</h4>
                            <div id="history-list" class="max-h-80 overflow-y-auto pr-2">
                                <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø³Ø¬Ù„ Ù‡Ù†Ø§ -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Back to Library Button -->
            <div class="mt-6 text-center">
                <button onclick="window.location.href='data.html'" 
                        class="inline-flex items-center gap-2 px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-bold transition-all">
                    <i class="fas fa-book"></i>
                    Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙƒØªØ¨Ø©
                </button>
            </div>
        </section>
    </main>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 hidden">
        <div class="text-center">
            <div class="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
            <p class="text-white">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...</p>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA4efVo2ak3jhTslz-jFvHAkhEt-t9SVOQ",
            authDomain: "e-shop-aa5ea.firebasestorage.app",
            databaseURL: "https://e-shop-aa5ea-default-rtdb.firebaseio.com",
            projectId: "e-shop-aa5ea",
            storageBucket: "e-shop-aa5ea.firebasestorage.app",
            messagingSenderId: "751567638938",
            appId: "1:751567638938:android:63555c7081ec50c6dcaa23"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Global Variables
        let currentBook = null;
        let currentBookId = null;
        let currentBookPrice = null;
        let orderId = null;
        let countdownInterval = null;
        let timeLeft = 15 * 60;
        let selectedPaymentMethod = null;
        let userEmail = null;
        let userAccount = null;
        let orderKey = null;
        let userIdentifier = null;
        let currentOrder = null;
        let userData = null;

        // Initialize Page
        document.addEventListener('DOMContentLoaded', () => {
            // Get book ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            currentBookId = urlParams.get('book');
            
            if (!currentBookId) {
                showError('Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ ÙƒØªØ§Ø¨!');
                setTimeout(() => window.location.href = 'data.html', 2000);
                return;
            }
            
            // Load user data first
            loadUserData();
        });

        // Load User Data from Firebase
        function loadUserData() {
            showLoading(true);
            
            // First, get all users to find the current user
            const usersRef = database.ref('email');
            usersRef.once('value')
                .then(snapshot => {
                    if (snapshot.exists()) {
                        const users = snapshot.val();
                        const userKeys = Object.keys(users);
                        
                        // Get user from localStorage or use first user
                        const savedUserId = localStorage.getItem('eshop_user_id');
                        let userId = savedUserId;
                        
                        if (!userId && userKeys.length > 0) {
                            // Use first user if no saved user
                            userId = userKeys[0];
                            localStorage.setItem('eshop_user_id', userId);
                        }
                        
                        if (userId && users[userId]) {
                            userData = users[userId];
                            userEmail = userData.email || userData.userEmail || 'user@eshope.com';
                            userIdentifier = btoa(userEmail + '_' + currentBookId).replace(/=/g, '');
                            
                            // Update UI with user data
                            updateUserEmailUI();
                            
                            // Now load book details
                            loadBookDetails();
                        } else {
                            showLoading(false);
                            showError('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø³Ø§Ø¨ Ù…Ø³ØªØ®Ø¯Ù…!');
                        }
                    } else {
                        showLoading(false);
                        showError('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ø³Ø¬Ù„ÙŠÙ†!');
                    }
                })
                .catch(error => {
                    showLoading(false);
                    showError('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…');
                    console.error('Error loading user data:', error);
                });
        }

        // Load Book Details from Firebase
        function loadBookDetails() {
            const bookRef = database.ref(`books/${currentBookId}`);
            bookRef.once('value')
                .then(snapshot => {
                    if (snapshot.exists()) {
                        currentBook = snapshot.val();
                        currentBookPrice = currentBook.priceReal || currentBook.price || 0;
                        
                        // Update UI with book details
                        updateBookDetails();
                        
                        // Now check existing orders
                        checkExistingOrders();
                    } else {
                        showLoading(false);
                        showError('Ø§Ù„ÙƒØªØ§Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!');
                        setTimeout(() => window.location.href = 'data.html', 2000);
                    }
                })
                .catch(error => {
                    showLoading(false);
                    showError('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒØªØ§Ø¨');
                    console.error('Error loading book:', error);
                });
        }

        // Check Existing Orders
        function checkExistingOrders() {
            const payRef = database.ref('pay');
            
            // Search for orders with this user email and book ID
            payRef.orderByChild('email').equalTo(userEmail).once('value')
                .then(snapshot => {
                    showLoading(false);
                    
                    if (snapshot.exists()) {
                        const orders = snapshot.val();
                        const orderKeys = Object.keys(orders);
                        
                        // Filter orders for this book
                        let latestOrder = null;
                        let latestKey = null;
                        
                        orderKeys.forEach(key => {
                            const order = orders[key];
                            if (order.bookId === currentBookId) {
                                if (!latestOrder || order.timestamp > latestOrder.timestamp) {
                                    latestOrder = order;
                                    latestKey = key;
                                }
                            }
                        });
                        
                        if (latestOrder) {
                            currentOrder = latestOrder;
                            orderKey = latestKey;
                            orderId = latestOrder.orderId;
                            selectedPaymentMethod = latestOrder.paymentMethod;
                            userAccount = latestOrder.paymentNumber || latestOrder.account;
                            
                            // Handle based on state
                            handleStateBasedOnOrder(latestOrder.state);
                        } else {
                            // No orders found for this book, show payment method selection
                            showSection('section-payment-method');
                        }
                    } else {
                        // No orders at all, show payment method selection
                        showSection('section-payment-method');
                    }
                    
                    // Load history and statistics
                    loadPurchaseHistory();
                })
                .catch(error => {
                    showLoading(false);
                    console.error('Error checking existing orders:', error);
                    showSection('section-payment-method');
                });
        }

        // Handle State Based on Order
        function handleStateBasedOnOrder(state) {
            // Always show final section with status and history
            showSection('section-final');
            
            // Update current order details
            updateCurrentOrderDetails();
            
            // Handle state-specific UI
            switch(state) {
                case 'ok':
                    // Show download section
                    document.getElementById('download-section').classList.remove('hidden');
                    document.getElementById('retry-section').classList.add('hidden');
                    updateStatusUI('ok');
                    break;
                    
                case 'no':
                    // Show retry section
                    document.getElementById('download-section').classList.add('hidden');
                    document.getElementById('retry-section').classList.remove('hidden');
                    updateStatusUI('no');
                    break;
                    
                case 'tdd':
                    // Show pending status
                    document.getElementById('download-section').classList.add('hidden');
                    document.getElementById('retry-section').classList.add('hidden');
                    updateStatusUI('tdd');
                    
                    // Start monitoring for changes
                    monitorOrderStatus();
                    break;
            }
        }

        // Update Current Order Details
        function updateCurrentOrderDetails() {
            if (!currentOrder) return;
            
            document.getElementById('current-order-id').textContent = currentOrder.orderId || '-';
            document.getElementById('current-order-email').textContent = currentOrder.email || userEmail;
            document.getElementById('current-payment-method').textContent = 
                currentOrder.paymentMethod === 'wallet' ? 'Ù…Ø­ÙØ¸Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©' : 'PayPal';
            document.getElementById('current-order-date').textContent = 
                currentOrder.timestampReadable || new Date(currentOrder.timestamp).toLocaleString('ar-SA');
        }

        // Update Status UI
        function updateStatusUI(state) {
            const statusIcon = document.getElementById('status-icon');
            const statusTitle = document.getElementById('status-title');
            const statusMessage = document.getElementById('status-message');
            const currentStatusBadge = document.getElementById('current-status-badge');
            
            switch(state) {
                case 'tdd':
                    statusIcon.className = 'w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 border-4 border-yellow-500/30';
                    statusIcon.innerHTML = '<i class="fas fa-clock text-3xl text-yellow-500"></i>';
                    statusTitle.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©';
                    statusMessage.textContent = 'ÙŠØªÙ… Ø­Ø§Ù„ÙŠØ§Ù‹ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ';
                    currentStatusBadge.innerHTML = '<span class="status-badge status-tdd"><i class="fas fa-clock"></i> Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</span>';
                    break;
                    
                case 'ok':
                    statusIcon.className = 'w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 border-4 border-green-500/30';
                    statusIcon.innerHTML = '<i class="fas fa-check-circle text-3xl text-green-500"></i>';
                    statusTitle.textContent = 'ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©';
                    statusMessage.textContent = 'ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­';
                    currentStatusBadge.innerHTML = '<span class="status-badge status-ok"><i class="fas fa-check-circle"></i> Ù†Ø¬Ø§Ø­</span>';
                    break;
                    
                case 'no':
                    statusIcon.className = 'w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 border-4 border-red-500/30';
                    statusIcon.innerHTML = '<i class="fas fa-times-circle text-3xl text-red-500"></i>';
                    statusTitle.textContent = 'ØªÙ… Ø§Ù„Ø±ÙØ¶';
                    statusMessage.textContent = 'Ø¹Ø°Ø±Ø§Ù‹ØŒ ØªÙ… Ø±ÙØ¶ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯ÙØ¹';
                    currentStatusBadge.innerHTML = '<span class="status-badge status-no"><i class="fas fa-times-circle"></i> ÙØ´Ù„</span>';
                    break;
            }
        }

        // Monitor Order Status Changes
        function monitorOrderStatus() {
            if (!orderKey) return;
            
            const orderRef = database.ref(`pay/${orderKey}/state`);
            
            orderRef.on('value', (snapshot) => {
                if (snapshot.exists()) {
                    const state = snapshot.val();
                    handleStateBasedOnOrder(state);
                    
                    // Update history when state changes
                    loadPurchaseHistory();
                }
            });
        }

        // Load Purchase History
        function loadPurchaseHistory() {
            const payRef = database.ref('pay');
            
            payRef.orderByChild('email').equalTo(userEmail).once('value')
                .then(snapshot => {
                    const historyList = document.getElementById('history-list');
                    historyList.innerHTML = '';
                    
                    let total = 0;
                    let okCount = 0;
                    let noCount = 0;
                    let tddCount = 0;
                    
                    if (snapshot.exists()) {
                        const orders = snapshot.val();
                        const orderKeys = Object.keys(orders);
                        
                        // Filter orders for this book and sort by timestamp
                        const bookOrders = orderKeys
                            .filter(key => orders[key].bookId === currentBookId)
                            .map(key => ({
                                key,
                                ...orders[key]
                            }))
                            .sort((a, b) => b.timestamp - a.timestamp);
                        
                        // Count statistics
                        bookOrders.forEach(order => {
                            total++;
                            if (order.state === 'ok') okCount++;
                            if (order.state === 'no') noCount++;
                            if (order.state === 'tdd') tddCount++;
                        });
                        
                        // Update statistics
                        document.getElementById('history-total').textContent = total;
                        document.getElementById('history-ok').textContent = okCount;
                        document.getElementById('history-no').textContent = noCount;
                        
                        // Add orders to history list
                        bookOrders.forEach(order => {
                            addToHistoryList(order);
                        });
                    } else {
                        document.getElementById('history-total').textContent = '0';
                        document.getElementById('history-ok').textContent = '0';
                        document.getElementById('history-no').textContent = '0';
                        
                        historyList.innerHTML = `
                            <div class="text-center py-8 text-gray-500">
                                <i class="fas fa-history text-3xl mb-3 opacity-30"></i>
                                <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ø´Ø±Ø§Ø¡ Ø³Ø§Ø¨Ù‚Ø©</p>
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Error loading purchase history:', error);
                });
        }

        // Add to History List
        function addToHistoryList(order) {
            const historyList = document.getElementById('history-list');
            
            let statusBadge = '';
            let statusClass = '';
            
            switch(order.state) {
                case 'tdd':
                    statusBadge = '<span class="px-2 py-1 bg-yellow-900/30 text-yellow-400 rounded text-xs">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</span>';
                    statusClass = 'tdd';
                    break;
                case 'ok':
                    statusBadge = '<span class="px-2 py-1 bg-green-900/30 text-green-400 rounded text-xs">Ù†Ø¬Ø§Ø­</span>';
                    statusClass = 'ok';
                    break;
                case 'no':
                    statusBadge = '<span class="px-2 py-1 bg-red-900/30 text-red-400 rounded text-xs">ÙØ´Ù„</span>';
                    statusClass = 'no';
                    break;
            }
            
            const orderDate = order.timestampReadable || new Date(order.timestamp).toLocaleString('ar-SA');
            
            const orderHtml = `
                <div class="history-card ${statusClass}">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <div class="flex items-center gap-2 mb-1">
                                <span class="font-bold text-sm">${order.orderId || 'N/A'}</span>
                                ${statusBadge}
                            </div>
                            <p class="text-xs text-gray-400">${orderDate}</p>
                        </div>
                        <span class="font-bold text-blue-400">${formatPrice(order.bookPrice || 0)}</span>
                    </div>
                    
                    <div class="text-xs text-gray-400">
                        <div class="flex items-center gap-1 mb-1">
                            <i class="fas fa-${order.paymentMethod === 'wallet' ? 'wallet' : 'paypal'}"></i>
                            <span>${order.paymentMethod === 'wallet' ? 'Ù…Ø­ÙØ¸Ø©' : 'PayPal'}</span>
                        </div>
                        ${order.paymentNumber ? `
                        <div class="truncate">
                            <i class="fas fa-credit-card"></i>
                            <span>${order.paymentNumber}</span>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            historyList.insertAdjacentHTML('beforeend', orderHtml);
        }

        // Update User Email in UI
        function updateUserEmailUI() {
            document.getElementById('current-user-email').textContent = userEmail;
            document.getElementById('user-email-display').textContent = userEmail;
            document.getElementById('user-email-badge').classList.remove('hidden');
        }

        // Update Book Details in UI
        function updateBookDetails() {
            // Book info in preview
            const bookTitle = currentBook.name || 'ÙƒØªØ§Ø¨';
            const bookDescription = currentBook.dec || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ Ù…ØªØ§Ø­';
            
            document.getElementById('book-preview-title').textContent = bookTitle;
            document.getElementById('book-preview-price').textContent = formatPrice(currentBookPrice);
            document.getElementById('book-title').textContent = bookTitle;
            document.getElementById('book-price').textContent = formatPrice(currentBookPrice);
            document.getElementById('exact-amount').textContent = formatPrice(currentBookPrice);
            
            // Set book images
            const bookImages = [
                'book-preview-image',
                'book-image',
                'history-book-image'
            ];
            
            bookImages.forEach(id => {
                const img = document.getElementById(id);
                if (currentBook.img1) {
                    img.src = currentBook.img1;
                } else {
                    img.src = 'https://images.unsplash.com/photo-1544716278-ca5e3f4abd8c?ixlib=rb-4.0.3&auto=format&fit=crop&w=200&q=80';
                }
            });
            
            // Update other sections
            document.getElementById('history-book-title').textContent = bookTitle;
            document.getElementById('history-book-description').textContent = bookDescription;
            document.getElementById('history-book-price').textContent = formatPrice(currentBookPrice);
            
            // Show old price if available
            if (currentBook.price && currentBook.priceReal) {
                document.getElementById('book-old-price').textContent = formatPrice(currentBook.price);
            }
            
            // Update download link if available
            if (currentBook.download) {
                const downloadLink = document.getElementById('download-link');
                downloadLink.href = currentBook.download;
            }
        }

        // Select Payment Method
        function selectPaymentMethod(method) {
            selectedPaymentMethod = method;
            
            // Update UI
            document.querySelectorAll('.payment-method-card').forEach(card => {
                card.classList.remove('selected');
                const check = card.querySelector('.payment-check');
                check.style.background = 'transparent';
                check.style.borderColor = '#666';
            });
            
            const selectedCard = document.getElementById(`${method}-card`);
            selectedCard.classList.add('selected');
            const check = selectedCard.querySelector('.payment-check');
            check.style.background = '#0066cc';
            check.style.borderColor = '#0066cc';
            check.innerHTML = '<i class="fas fa-check text-white text-xs"></i>';
            
            // Show/hide input fields
            if (method === 'wallet') {
                document.getElementById('wallet-number-input').classList.remove('hidden');
                document.getElementById('paypal-account-input').classList.add('hidden');
            } else {
                document.getElementById('wallet-number-input').classList.add('hidden');
                document.getElementById('paypal-account-input').classList.remove('hidden');
            }
            
            // Enable proceed button
            document.getElementById('proceed-btn').disabled = false;
        }

        // Proceed to Payment Instructions
        function proceedToPaymentInstructions() {
            if (!selectedPaymentMethod) {
                showError('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹');
                return;
            }
            
            // Validate inputs
            let isValid = true;
            
            if (selectedPaymentMethod === 'wallet') {
                const walletNumber = document.getElementById('wallet-number').value.trim();
                
                if (!walletNumber) {
                    showError('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø©');
                    isValid = false;
                }
                
                // Validate wallet number
                const phoneRegex = /^01[0-9]{9}$/;
                if (!phoneRegex.test(walletNumber)) {
                    showError('Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø© ØºÙŠØ± ØµØ­ÙŠØ­. ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 11 Ø±Ù‚Ù… ÙˆÙŠØ¨Ø¯Ø£ Ø¨Ù€ 01');
                    isValid = false;
                }
                
                if (isValid) {
                    userAccount = walletNumber;
                }
            } else {
                const paypalAccount = document.getElementById('paypal-account').value.trim();
                
                if (!paypalAccount) {
                    showError('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ');
                    isValid = false;
                }
                
                if (isValid) {
                    userAccount = paypalAccount;
                }
            }
            
            if (!isValid) return;
            
            // Update payment details
            if (selectedPaymentMethod === 'wallet') {
                document.getElementById('from-number').textContent = userAccount;
            }
            
            // Show payment instructions
            showSection('section-payment-instructions');
            
            // Update instructions based on payment method
            if (selectedPaymentMethod === 'wallet') {
                document.getElementById('wallet-instructions').classList.remove('hidden');
                document.getElementById('paypal-instructions').classList.add('hidden');
            } else {
                document.getElementById('wallet-instructions').classList.add('hidden');
                document.getElementById('paypal-instructions').classList.remove('hidden');
            }
            
            // Start countdown
            startCountdown();
        }

        // Start Countdown Timer
        function startCountdown() {
            const countdownElement = document.getElementById('countdown');
            timeLeft = 15 * 60;
            
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }
            
            countdownInterval = setInterval(() => {
                timeLeft--;
                
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                
                countdownElement.textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                if (timeLeft <= 0) {
                    clearInterval(countdownInterval);
                    showError('Ø§Ù†ØªÙ‡Ù‰ ÙˆÙ‚Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ©!');
                    setTimeout(() => {
                        window.location.href = 'data.html';
                    }, 3000);
                }
            }, 1000);
        }

        // Copy to Clipboard
        function copyToClipboard(type) {
            let text = '';
            
            if (type === 'from') {
                text = document.getElementById('from-number').textContent;
            } else if (type === 'to') {
                text = '01009341792';
            }
            
            navigator.clipboard.writeText(text)
                .then(() => {
                    const btn = event.currentTarget;
                    const icon = btn.querySelector('i');
                    
                    // Change icon
                    icon.className = 'fas fa-check';
                    btn.classList.add('copied');
                    
                    showNotification('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ù‚Ù… Ø¨Ù†Ø¬Ø§Ø­', 'success');
                    
                    setTimeout(() => {
                        icon.className = 'fas fa-copy';
                        btn.classList.remove('copied');
                    }, 2000);
                })
                .catch(err => {
                    console.error('Failed to copy:', err);
                    showNotification('ÙØ´Ù„ ÙÙŠ Ø§Ù„Ù†Ø³Ø®', 'error');
                });
        }

        // Confirm Payment and Save Order
        function confirmPayment() {
            showLoading(true);
            
            // Generate order ID
            orderId = 'ORD-' + Date.now();
            orderKey = 'order_' + Date.now();
            
            // Prepare order data for 'pay' collection
            const orderData = {
                email: userEmail,
                state: "tdd", // Default state
                paymentMethod: selectedPaymentMethod,
                paymentNumber: userAccount,
                bookId: currentBookId,
                bookName: currentBook.name || 'ÙƒØªØ§Ø¨',
                bookDescription: currentBook.dec || '',
                bookPrice: currentBookPrice,
                bookImage: currentBook.img1 || '',
                userName: userData.name || userData.userName || 'Ù…Ø³ØªØ®Ø¯Ù…',
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                timestampReadable: new Date().toLocaleString('ar-SA'),
                orderId: orderId
            };
            
            // Save to Firebase under 'pay' collection
            const payRef = database.ref(`pay/${orderKey}`);
            
            payRef.set(orderData)
                .then(() => {
                    showLoading(false);
                    
                    // Stop countdown
                    if (countdownInterval) {
                        clearInterval(countdownInterval);
                    }
                    
                    // Set as current order
                    currentOrder = orderData;
                    
                    // Show final section
                    handleStateBasedOnOrder('tdd');
                })
                .catch(error => {
                    showLoading(false);
                    showError('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨');
                    console.error('Error saving order:', error);
                });
        }

        // Navigation Functions
        function showSection(sectionId) {
            // Hide all sections
            const sectionsToHide = [
                'section-auto-check',
                'section-payment-method',
                'section-payment-instructions',
                'section-final'
            ];
            
            sectionsToHide.forEach(id => {
                const section = document.getElementById(id);
                if (section) {
                    section.classList.remove('visible-section');
                    section.classList.add('hidden-section');
                }
            });
            
            // Show target section
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.remove('hidden-section');
                targetSection.classList.add('visible-section');
            }
            
            // Scroll to top
            window.scrollTo(0, 0);
        }

        function backToPaymentMethod() {
            showSection('section-payment-method');
        }

        // Action Functions
        function checkOrderStatus() {
            showLoading(true);
            
            setTimeout(() => {
                showLoading(false);
                showNotification('Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨...', 'info');
            }, 1000);
        }

        function retryPurchase() {
            // Show payment method section for retry
            showSection('section-payment-method');
        }

        // Helper Functions
        function formatPrice(price) {
            if (!price && price !== 0) return '0 Ø¬Ù†ÙŠÙ‡';
            const num = parseInt(price);
            if (isNaN(num)) return price;
            return num.toLocaleString('ar-SA') + ' Ø¬Ù†ÙŠÙ‡';
        }

        function showLoading(show) {
            const overlay = document.getElementById('loading-overlay');
            overlay.classList.toggle('hidden', !show);
        }

        function showNotification(message, type = 'info') {
            document.querySelectorAll('.notification').forEach(n => n.remove());
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-${type === 'error' ? 'exclamation-circle' : type === 'success' ? 'check-circle' : 'info-circle'}"></i>
                        <span>${message}</span>
                    </div>
                    <button onclick="this.parentElement.parentElement.classList.add('fade-out')" 
                            class="text-white/70 hover:text-white ml-4">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.classList.add('fade-out');
                    setTimeout(() => {
                        if (notification.parentElement) {
                            notification.remove();
                        }
                    }, 300);
                }
            }, 5000);
        }

        function showError(message) {
            showNotification(message, 'error');
        }
    </script>
</body>
</html>
