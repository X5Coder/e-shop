<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>E-Shop Pro | Ø§ÙƒÙ…Ø§Ù„ Ø§Ù„Ø´Ø±Ø§Ø¡</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        :root {
            --primary: #0066cc;
            --secondary: #cc3333;
            --bg-dark: #0a0a0a;
            --text-dark: #f5f5f5;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-dark);
        }

        .glass {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .step-line {
            width: 60px;
            height: 2px;
            background: rgba(255, 255, 255, 0.1);
        }

        .step.active .step-circle {
            background: var(--primary);
            color: white;
        }

        .step.completed .step-circle {
            background: var(--success);
            color: white;
        }

        .step.pending .step-circle {
            background: rgba(255, 255, 255, 0.1);
            color: #999;
        }

        .step-label {
            font-size: 12px;
            color: #999;
        }

        .step.active .step-label {
            color: var(--primary);
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .status-pending {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .status-approved {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .status-rejected {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .copy-btn {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .copy-btn:hover {
            opacity: 0.8;
        }

        .copy-btn.copied {
            background: var(--success) !important;
        }

        .countdown-timer {
            font-family: monospace;
            font-size: 1.2em;
            color: var(--primary);
            font-weight: bold;
        }

        .receipt {
            background: rgba(255, 255, 255, 0.05);
            border: 1px dashed rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 15px;
        }

        .receipt-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .receipt-item:last-child {
            border-bottom: none;
        }

        .receipt-total {
            font-weight: bold;
            color: var(--primary);
            font-size: 1.1em;
        }

        .hidden-section {
            overflow: hidden;
            max-height: 0;
            opacity: 0;
            transition: all 0.5s ease;
        }

        .hidden-section.show {
            max-height: 500px;
            opacity: 1;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="glass px-4 py-3 flex items-center gap-3 sticky top-0 z-50">
        <button onclick="window.history.back()" class="w-10 h-10 flex items-center justify-center rounded-2xl bg-white/5 hover:bg-white/10 transition-all">
            <i class="fas fa-arrow-right text-white"></i>
        </button>
        <h1 class="text-xl font-bold flex-1">Ø§ÙƒÙ…Ø§Ù„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø´Ø±Ø§Ø¡</h1>
        <div id="order-status" class="hidden">
            <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ù‡Ù†Ø§ -->
        </div>
    </header>

    <!-- Main Content -->
    <main class="p-4 max-w-md mx-auto" id="main-content">
        <!-- Step Indicators -->
        <div class="step-indicator">
            <div class="step active" id="step1">
                <div class="step-circle">1</div>
                <div class="step-label">Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</div>
            </div>
            <div class="step-line"></div>
            <div class="step pending" id="step2">
                <div class="step-circle">2</div>
                <div class="step-label">Ø§Ù„Ø¯ÙØ¹</div>
            </div>
            <div class="step-line"></div>
            <div class="step pending" id="step3">
                <div class="step-circle">3</div>
                <div class="step-label">Ø§Ù„ØªØ£ÙƒÙŠØ¯</div>
            </div>
        </div>

        <!-- Section 1: Customer Information -->
        <div id="section-info" class="glass rounded-2xl p-6 mb-4">
            <h2 class="text-xl font-bold mb-6 text-center">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</h2>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„</label>
                    <input type="text" id="customer-name" 
                           class="w-full p-3 bg-white/5 border border-white/10 rounded-xl focus:outline-none focus:border-blue-500 transition-all"
                           placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„">
                </div>
                
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                    <input type="tel" id="customer-phone" 
                           class="w-full p-3 bg-white/5 border border-white/10 rounded-xl focus:outline-none focus:border-blue-500 transition-all"
                           placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙÙƒ">
                </div>
                
                <button onclick="showPaymentSection()" 
                        class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-bold mt-6 transition-all">
                    Ø§Ù„ØªØ§Ù„ÙŠ Ø¥Ù„Ù‰ Ø§Ù„Ø¯ÙØ¹
                </button>
            </div>
        </div>

        <!-- Section 2: Payment Information -->
        <div id="section-payment" class="hidden-section">
            <div class="glass rounded-2xl p-6">
                <h2 class="text-xl font-bold mb-6 text-center">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯ÙØ¹</h2>
                
                <!-- Book Details -->
                <div class="mb-6 p-4 bg-white/5 rounded-xl">
                    <h3 class="font-bold mb-2" id="book-title">ÙƒØªØ§Ø¨ Ø§Ù„Ù…Ø¨Ø±Ù…Ø¬ Ø§Ù„Ù…Ø­ØªØ±Ù</h3>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">Ø§Ù„Ø³Ø¹Ø±:</span>
                        <span class="font-bold text-blue-400" id="book-price">50 Ø¬Ù†ÙŠÙ‡</span>
                    </div>
                </div>
                
                <!-- Payment Instructions -->
                <div class="mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-bold">ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø¯ÙØ¹</h3>
                        <span class="text-xs text-gray-400">Ø±Ù‚Ù… Ø«Ø§Ø¨Øª Ù„Ù„Ø¯ÙØ¹</span>
                    </div>
                    
                    <div class="receipt mb-4">
                        <div class="receipt-item">
                            <span>Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨:</span>
                            <div class="flex items-center gap-2">
                                <span id="account-number" class="font-mono">01009341792</span>
                                <button onclick="copyToClipboard('01009341792')" 
                                        class="copy-btn w-8 h-8 flex items-center justify-center bg-white/5 rounded-lg">
                                    <i class="fas fa-copy text-sm"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="receipt-item">
                            <span>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:</span>
                            <span id="payment-amount" class="font-bold">50 Ø¬Ù†ÙŠÙ‡</span>
                        </div>
                        
                        <div class="receipt-item">
                            <span>Ù†ÙˆØ¹ Ø§Ù„ØªØ­ÙˆÙŠÙ„:</span>
                            <span>ØªØ­ÙˆÙŠÙ„ ÙÙˆØ±ÙŠ</span>
                        </div>
                    </div>
                    
                    <div class="bg-blue-900/20 border border-blue-500/30 rounded-xl p-4 mb-4">
                        <p class="text-sm">
                            <i class="fas fa-info-circle text-blue-400 mr-2"></i>
                            ÙŠØ¬Ø¨ ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ø§Ù„Ø¶Ø¨Ø· ÙƒÙ…Ø§ Ù‡Ùˆ Ù…ÙˆØ¶Ø­ Ø£Ø¹Ù„Ø§Ù‡ Ø¥Ù„Ù‰ Ø§Ù„Ø±Ù‚Ù… 
                            <span class="font-bold">01009341792</span>
                            Ø«Ù… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø£Ø¯Ù†Ø§Ù‡
                        </p>
                    </div>
                </div>
                
                <!-- Countdown Timer -->
                <div class="mb-6 text-center">
                    <div class="inline-flex items-center gap-2 px-4 py-2 bg-white/5 rounded-xl">
                        <i class="fas fa-clock text-blue-400"></i>
                        <span class="text-sm text-gray-400">Ù…ØªØ¨Ù‚ÙŠ Ù„Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©:</span>
                        <span id="countdown" class="countdown-timer">15:00</span>
                    </div>
                    <p class="text-xs text-gray-400 mt-2">Ø³ÙŠØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ÙˆÙ‚Øª</p>
                </div>
                
                <!-- Confirm Payment Button -->
                <button onclick="confirmPayment()" 
                        class="w-full py-3 bg-green-600 hover:bg-green-700 text-white rounded-xl font-bold transition-all">
                    <i class="fas fa-check-circle mr-2"></i>
                    ØªØ£ÙƒÙŠØ¯ Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø¯ÙØ¹
                </button>
                
                <button onclick="backToInfoSection()" 
                        class="w-full py-3 bg-white/5 hover:bg-white/10 rounded-xl font-bold mt-3 transition-all">
                    Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø®Ù„Ù
                </button>
            </div>
        </div>

        <!-- Section 3: Order Status -->
        <div id="section-status" class="hidden-section">
            <div class="glass rounded-2xl p-6">
                <div class="text-center mb-6">
                    <div id="status-icon" class="w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 border-4">
                        <i class="fas fa-clock text-3xl"></i>
                    </div>
                    
                    <h2 id="status-title" class="text-xl font-bold mb-2">Ø¬Ø§Ø±ÙŠ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¯ÙØ¹</h2>
                    <p id="status-message" class="text-gray-400">
                        ÙŠØªÙ… Ø­Ø§Ù„ÙŠØ§Ù‹ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ. Ø³ÙŠØªÙ… Ø¥Ø¹Ù„Ø§Ù…Ùƒ ÙÙˆØ± Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©.
                    </p>
                </div>
                
                <!-- Order Details -->
                <div class="mb-6">
                    <h3 class="font-bold mb-4 border-b border-white/10 pb-2">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-gray-400">Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨:</span>
                            <span id="order-id" class="font-mono">#</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Ø§Ù„ÙƒØªØ§Ø¨:</span>
                            <span id="order-book" class="font-bold">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Ø§Ù„Ù…Ø¨Ù„Øº:</span>
                            <span id="order-amount" class="font-bold">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Ø§Ù„ØªØ§Ø±ÙŠØ®:</span>
                            <span id="order-date" class="font-bold">-</span>
                        </div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div id="action-buttons" class="space-y-3">
                    <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø­Ø³Ø¨ Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ -->
                </div>
            </div>
        </div>
    </main>

    <!-- Download Button (Hidden by default) -->
    <div id="download-section" class="hidden p-4 max-w-md mx-auto">
        <div class="glass rounded-2xl p-6 text-center">
            <div class="w-20 h-20 bg-green-600/20 rounded-full flex items-center justify-center mx-auto mb-6 border-4 border-green-500/30">
                <i class="fas fa-download text-green-500 text-3xl"></i>
            </div>
            
            <h2 class="text-xl font-bold mb-4">ØªÙ… Ø§Ù„Ø¯ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­! ğŸ‰</h2>
            <p class="text-gray-400 mb-6">Ø´ÙƒØ±Ø§Ù‹ Ù„Ø´Ø±Ø§Ø¦Ùƒ. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒØªØ§Ø¨.</p>
            
            <a id="download-link" href="#" target="_blank" 
               class="block w-full py-3 bg-green-600 hover:bg-green-700 text-white rounded-xl font-bold mb-3 transition-all">
                <i class="fas fa-download mr-2"></i>
                ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒØªØ§Ø¨
            </a>
            
            <button onclick="window.location.href='data.html'" 
                    class="w-full py-3 bg-white/5 hover:bg-white/10 rounded-xl font-bold">
                Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙƒØªØ¨Ø©
            </button>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 hidden">
        <div class="text-center">
            <div class="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
            <p class="text-white">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...</p>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA4efVo2ak3jhTslz-jFvHAkhEt-t9SVOQ",
            authDomain: "e-shop-aa5ea.firebaseapp.com",
            databaseURL: "https://e-shop-aa5ea-default-rtdb.firebaseio.com",
            projectId: "e-shop-aa5ea",
            storageBucket: "e-shop-aa5ea.firebasestorage.app",
            messagingSenderId: "751567638938",
            appId: "1:751567638938:android:63555c7081ec50c6dcaa23"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Global Variables
        let currentBook = null;
        let currentBookId = null;
        let currentBookPrice = null;
        let orderId = null;
        let countdownInterval = null;
        let timeLeft = 15 * 60; // 15 minutes in seconds
        let userPhone = null;

        // Initialize Page
        document.addEventListener('DOMContentLoaded', () => {
            // Get book ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            currentBookId = urlParams.get('book');
            
            if (!currentBookId) {
                showError('Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ ÙƒØªØ§Ø¨!');
                setTimeout(() => window.location.href = 'data.html', 2000);
                return;
            }
            
            // Load book details
            loadBookDetails();
            
            // Check for existing order
            checkExistingOrder();
        });

        // Load Book Details from Firebase
        function loadBookDetails() {
            showLoading(true);
            
            const bookRef = database.ref(`books/${currentBookId}`);
            bookRef.once('value')
                .then(snapshot => {
                    showLoading(false);
                    
                    if (snapshot.exists()) {
                        currentBook = snapshot.val();
                        currentBookPrice = currentBook.priceReal || currentBook.price || 0;
                        
                        // Update UI with book details
                        document.getElementById('book-title').textContent = currentBook.name || 'ÙƒØªØ§Ø¨';
                        document.getElementById('book-price').textContent = formatPrice(currentBookPrice);
                        document.getElementById('payment-amount').textContent = formatPrice(currentBookPrice);
                        
                        // Update order details
                        document.getElementById('order-book').textContent = currentBook.name || 'ÙƒØªØ§Ø¨';
                        document.getElementById('order-amount').textContent = formatPrice(currentBookPrice);
                    } else {
                        showError('Ø§Ù„ÙƒØªØ§Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!');
                        setTimeout(() => window.location.href = 'data.html', 2000);
                    }
                })
                .catch(error => {
                    showLoading(false);
                    showError('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒØªØ§Ø¨');
                    console.error('Error loading book:', error);
                });
        }

        // Show Information Section
        function showPaymentSection() {
            const name = document.getElementById('customer-name').value.trim();
            const phone = document.getElementById('customer-phone').value.trim();
            
            if (!name || !phone) {
                showError('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©');
                return;
            }
            
            if (phone.length < 10) {
                showError('Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØºÙŠØ± ØµØ­ÙŠØ­');
                return;
            }
            
            userPhone = phone;
            
            // Update steps
            document.getElementById('step1').classList.remove('active');
            document.getElementById('step1').classList.add('completed');
            document.getElementById('step2').classList.remove('pending');
            document.getElementById('step2').classList.add('active');
            
            // Show payment section
            document.getElementById('section-info').style.display = 'none';
            document.getElementById('section-payment').classList.add('show');
            
            // Start countdown
            startCountdown();
        }

        // Back to Information Section
        function backToInfoSection() {
            // Update steps
            document.getElementById('step1').classList.remove('completed');
            document.getElementById('step1').classList.add('active');
            document.getElementById('step2').classList.remove('active');
            document.getElementById('step2').classList.add('pending');
            
            // Show info section
            document.getElementById('section-payment').classList.remove('show');
            document.getElementById('section-info').style.display = 'block';
            
            // Stop countdown
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }
        }

        // Start Countdown Timer
        function startCountdown() {
            const countdownElement = document.getElementById('countdown');
            
            countdownInterval = setInterval(() => {
                timeLeft--;
                
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                
                countdownElement.textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                if (timeLeft <= 0) {
                    clearInterval(countdownInterval);
                    showError('Ø§Ù†ØªÙ‡Ù‰ ÙˆÙ‚Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ©!');
                    setTimeout(() => window.location.href = 'data.html', 3000);
                }
            }, 1000);
        }

        // Copy to Clipboard
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text)
                .then(() => {
                    const btn = event.currentTarget;
                    const icon = btn.querySelector('i');
                    
                    // Change icon
                    icon.className = 'fas fa-check';
                    btn.classList.add('copied');
                    
                    // Reset after 2 seconds
                    setTimeout(() => {
                        icon.className = 'fas fa-copy';
                        btn.classList.remove('copied');
                    }, 2000);
                })
                .catch(err => {
                    console.error('Failed to copy:', err);
                });
        }

        // Confirm Payment and Save Order
        function confirmPayment() {
            const name = document.getElementById('customer-name').value.trim();
            
            if (!name || !userPhone) {
                showError('ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }
            
            // Generate unique order ID
            orderId = 'ORD-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            
            // Prepare order data
            const orderData = {
                id: orderId,
                bookId: currentBookId,
                bookName: currentBook.name || 'ÙƒØªØ§Ø¨',
                price: currentBookPrice,
                customerName: name,
                customerPhone: userPhone,
                status: 'pending', // pending, approved, rejected
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                paymentMethod: 'vodafone_cash',
                paymentAccount: '01009341792',
                attempts: 1
            };
            
            showLoading(true);
            
            // Save order to Firebase
            const orderRef = database.ref(`orders/${userPhone}_${currentBookId}`);
            orderRef.set(orderData)
                .then(() => {
                    showLoading(false);
                    
                    // Update steps
                    document.getElementById('step2').classList.remove('active');
                    document.getElementById('step2').classList.add('completed');
                    document.getElementById('step3').classList.remove('pending');
                    document.getElementById('step3').classList.add('active');
                    
                    // Show status section
                    document.getElementById('section-payment').classList.remove('show');
                    document.getElementById('section-status').classList.add('show');
                    
                    // Update order details
                    document.getElementById('order-id').textContent = orderId;
                    document.getElementById('order-date').textContent = new Date().toLocaleDateString('ar-SA');
                    
                    // Stop countdown
                    if (countdownInterval) {
                        clearInterval(countdownInterval);
                    }
                    
                    // Start monitoring order status
                    monitorOrderStatus();
                })
                .catch(error => {
                    showLoading(false);
                    showError('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
                    console.error('Error saving order:', error);
                });
        }

        // Monitor Order Status Changes
        function monitorOrderStatus() {
            const orderRef = database.ref(`orders/${userPhone}_${currentBookId}`);
            
            orderRef.on('value', (snapshot) => {
                if (snapshot.exists()) {
                    const order = snapshot.val();
                    updateOrderStatusUI(order.status);
                    
                    // If approved, show download section
                    if (order.status === 'approved') {
                        showDownloadSection();
                    }
                }
            });
        }

        // Update Order Status UI
        function updateOrderStatusUI(status) {
            const statusIcon = document.getElementById('status-icon');
            const statusTitle = document.getElementById('status-title');
            const statusMessage = document.getElementById('status-message');
            const actionButtons = document.getElementById('action-buttons');
            const headerStatus = document.getElementById('order-status');
            
            // Update header status
            headerStatus.innerHTML = '';
            headerStatus.classList.remove('hidden');
            
            switch(status) {
                case 'pending':
                    statusIcon.className = 'w-20 h-20 bg-yellow-600/20 rounded-full flex items-center justify-center mx-auto mb-4 border-4 border-yellow-500/30';
                    statusIcon.innerHTML = '<i class="fas fa-clock text-yellow-500 text-3xl"></i>';
                    statusTitle.textContent = 'Ø¬Ø§Ø±ÙŠ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¯ÙØ¹';
                    statusMessage.textContent = 'ÙŠØªÙ… Ø­Ø§Ù„ÙŠØ§Ù‹ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ. Ø³ÙŠØªÙ… Ø¥Ø¹Ù„Ø§Ù…Ùƒ ÙÙˆØ± Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©.';
                    
                    headerStatus.innerHTML = '<span class="status-badge status-pending"><i class="fas fa-clock"></i> Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</span>';
                    
                    actionButtons.innerHTML = `
                        <button onclick="checkPaymentAgain()" class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-bold transition-all">
                            <i class="fas fa-sync-alt mr-2"></i>
                            ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©
                        </button>
                    `;
                    break;
                    
                case 'approved':
                    statusIcon.className = 'w-20 h-20 bg-green-600/20 rounded-full flex items-center justify-center mx-auto mb-4 border-4 border-green-500/30';
                    statusIcon.innerHTML = '<i class="fas fa-check-circle text-green-500 text-3xl"></i>';
                    statusTitle.textContent = 'ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¨Ù†Ø¬Ø§Ø­!';
                    statusMessage.textContent = 'ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø·Ù„Ø¨Ùƒ ÙˆØ§ÙƒØªÙ…Ù„Øª Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø´Ø±Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­.';
                    
                    headerStatus.innerHTML = '<span class="status-badge status-approved"><i class="fas fa-check-circle"></i> ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©</span>';
                    
                    actionButtons.innerHTML = `
                        <button onclick="showDownloadSection()" class="w-full py-3 bg-green-600 hover:bg-green-700 text-white rounded-xl font-bold transition-all">
                            <i class="fas fa-download mr-2"></i>
                            ÙÙ‡Ù…ØªØŒ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒØªØ§Ø¨
                        </button>
                    `;
                    break;
                    
                case 'rejected':
                    statusIcon.className = 'w-20 h-20 bg-red-600/20 rounded-full flex items-center justify-center mx-auto mb-4 border-4 border-red-500/30';
                    statusIcon.innerHTML = '<i class="fas fa-times-circle text-red-500 text-3xl"></i>';
                    statusTitle.textContent = 'ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨';
                    statusMessage.textContent = 'Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯ÙØ¹. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.';
                    
                    headerStatus.innerHTML = '<span class="status-badge status-rejected"><i class="fas fa-times-circle"></i> Ù…Ø±ÙÙˆØ¶</span>';
                    
                    actionButtons.innerHTML = `
                        <button onclick="retryPayment()" class="w-full py-3 bg-red-600 hover:bg-red-700 text-white rounded-xl font-bold transition-all">
                            <i class="fas fa-redo-alt mr-2"></i>
                            Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
                        </button>
                        <button onclick="window.location.href=\'data.html\'" class="w-full py-3 bg-white/5 hover:bg-white/10 rounded-xl font-bold transition-all">
                            Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙƒØªØ¨Ø©
                        </button>
                    `;
                    break;
            }
        }

        // Show Download Section
        function showDownloadSection() {
            document.getElementById('main-content').style.display = 'none';
            document.getElementById('download-section').classList.remove('hidden');
            
            // Get download link from Firebase
            const downloadRef = database.ref(`download/${currentBookId}`);
            downloadRef.once('value')
                .then(snapshot => {
                    if (snapshot.exists()) {
                        const downloadData = snapshot.val();
                        const downloadLink = document.getElementById('download-link');
                        
                        if (downloadData.url) {
                            downloadLink.href = downloadData.url;
                            downloadLink.innerHTML = '<i class="fas fa-download mr-2"></i> ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒØªØ§Ø¨';
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading download link:', error);
                });
        }

        // Check Existing Order
        function checkExistingOrder() {
            // Try to get phone from localStorage or sessionStorage
            const savedPhone = localStorage.getItem('user_phone') || sessionStorage.getItem('user_phone');
            
            if (savedPhone && currentBookId) {
                const orderRef = database.ref(`orders/${savedPhone}_${currentBookId}`);
                
                orderRef.once('value')
                    .then(snapshot => {
                        if (snapshot.exists()) {
                            const order = snapshot.val();
                            userPhone = savedPhone;
                            
                            // Pre-fill customer info
                            document.getElementById('customer-name').value = order.customerName || '';
                            document.getElementById('customer-phone').value = order.customerPhone || '';
                            
                            // Check order status
                            if (order.status === 'pending') {
                                // Show status section directly
                                showExistingOrderStatus(order);
                            } else if (order.status === 'approved') {
                                // Show download section directly
                                showDownloadSection();
                            } else if (order.status === 'rejected') {
                                // Show retry option
                                updateOrderStatusUI('rejected');
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error checking existing order:', error);
                    });
            }
        }

        // Show Existing Order Status
        function showExistingOrderStatus(order) {
            orderId = order.id;
            
            // Update steps
            document.getElementById('step1').classList.add('completed');
            document.getElementById('step2').classList.add('completed');
            document.getElementById('step3').classList.add('active');
            
            // Hide info and payment sections
            document.getElementById('section-info').style.display = 'none';
            document.getElementById('section-payment').style.display = 'none';
            
            // Show status section
            document.getElementById('section-status').classList.add('show');
            
            // Update order details
            document.getElementById('order-id').textContent = order.id;
            document.getElementById('order-date').textContent = new Date(order.timestamp).toLocaleDateString('ar-SA');
            
            // Start monitoring
            monitorOrderStatus();
        }

        // Retry Payment
        function retryPayment() {
            // Increment attempts count
            const orderRef = database.ref(`orders/${userPhone}_${currentBookId}`);
            
            orderRef.transaction(order => {
                if (order) {
                    order.attempts = (order.attempts || 1) + 1;
                    order.status = 'pending';
                    order.timestamp = firebase.database.ServerValue.TIMESTAMP;
                }
                return order;
            })
            .then(() => {
                // Show payment section again
                document.getElementById('section-status').classList.remove('show');
                document.getElementById('section-payment').classList.add('show');
                
                // Reset countdown
                timeLeft = 15 * 60;
                startCountdown();
            })
            .catch(error => {
                showError('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ù„Ø¨');
                console.error('Error updating order:', error);
            });
        }

        // Check Payment Again
        function checkPaymentAgain() {
            showLoading(true);
            
            // Simulate checking with delay
            setTimeout(() => {
                showLoading(false);
                
                // In real app, you would check with your backend
                // For now, we'll just show a message
                showError('Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ­Ø¯ÙŠØ«Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©. Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©...', 'info');
            }, 2000);
        }

        // Helper Functions
        function formatPrice(price) {
            if (!price) return '0';
            const num = parseInt(price);
            if (isNaN(num)) return price;
            return num.toLocaleString('ar-SA') + ' Ø¬Ù†ÙŠÙ‡';
        }

        function showLoading(show) {
            const overlay = document.getElementById('loading-overlay');
            overlay.classList.toggle('hidden', !show);
        }

        function showError(message, type = 'error') {
            // Create notification
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 left-4 max-w-md mx-auto p-4 rounded-xl font-bold text-center z-50 ${
                type === 'error' ? 'bg-red-600/90 text-white' : 'bg-blue-600/90 text-white'
            }`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Save user phone for future reference
        function saveUserPhone(phone) {
            localStorage.setItem('user_phone', phone);
            sessionStorage.setItem('user_phone', phone);
        }
    </script>
</body>
</html>
