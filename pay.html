<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>E-Shop Pro | Ø§ÙƒÙ…Ø§Ù„ Ø§Ù„Ø´Ø±Ø§Ø¡</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        :root {
            --primary: #0066cc;
            --secondary: #cc3333;
            --bg-dark: #0a0a0a;
            --text-dark: #f5f5f5;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-dark);
            min-height: 100vh;
        }

        .glass {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .step-line {
            width: 60px;
            height: 2px;
            background: rgba(255, 255, 255, 0.1);
        }

        .step.active .step-circle {
            background: var(--primary);
            color: white;
        }

        .step.completed .step-circle {
            background: var(--success);
            color: white;
        }

        .step.pending .step-circle {
            background: rgba(255, 255, 255, 0.1);
            color: #999;
        }

        .step-label {
            font-size: 12px;
            color: #999;
        }

        .step.active .step-label {
            color: var(--primary);
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .status-tdd {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .status-ok {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .status-no {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .copy-btn {
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .copy-btn:hover {
            opacity: 0.8;
            transform: scale(1.05);
        }

        .copy-btn.copied {
            background: var(--success) !important;
        }

        .countdown-timer {
            font-family: monospace;
            font-size: 1.2em;
            color: var(--primary);
            font-weight: bold;
        }

        .payment-info-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            border-left: 4px solid var(--primary);
        }

        .payment-method-card {
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .payment-method-card:hover {
            border-color: var(--primary);
            background: rgba(0, 102, 204, 0.1);
        }

        .payment-method-card.selected {
            border-color: var(--primary);
            background: rgba(0, 102, 204, 0.15);
        }

        .payment-number {
            font-family: monospace;
            font-size: 1.1em;
            letter-spacing: 1px;
            background: rgba(255, 255, 255, 0.05);
            padding: 8px 12px;
            border-radius: 8px;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .transfer-flow {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
            position: relative;
        }

        .transfer-flow::before {
            content: "";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60%;
            height: 2px;
            background: var(--primary);
            opacity: 0.3;
        }

        .transfer-arrow {
            color: var(--primary);
            font-size: 1.5em;
            z-index: 1;
            background: var(--bg-dark);
            padding: 0 10px;
        }

        .history-card {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border-right: 4px solid transparent;
        }

        .history-card.tdd {
            border-right-color: var(--warning);
        }

        .history-card.ok {
            border-right-color: var(--success);
        }

        .history-card.no {
            border-right-color: var(--error);
        }

        .book-image-small {
            width: 60px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
        }

        .hidden-section {
            display: none;
        }

        .visible-section {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            z-index: 1000;
            animation: slideIn 0.3s ease;
            max-width: 400px;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .notification.success {
            background: var(--success);
        }

        .notification.error {
            background: var(--error);
        }

        .notification.info {
            background: var(--primary);
        }

        .fade-out {
            animation: fadeOut 0.3s ease forwards;
        }

        @keyframes fadeOut {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(100%); }
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
        }

        .stat-label {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }

        .user-email-badge {
            background: rgba(0, 102, 204, 0.1);
            border: 1px solid rgba(0, 102, 204, 0.3);
            border-radius: 20px;
            padding: 4px 12px;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .payment-details-table {
            width: 100%;
            border-collapse: collapse;
        }

        .payment-details-table td {
            padding: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .payment-details-table td:first-child {
            color: #999;
            width: 40%;
        }

        .payment-details-table td:last-child {
            font-weight: bold;
        }

        .purchase-stats {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
        }

        .stat-label {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="glass px-4 py-3 flex items-center gap-3 sticky top-0 z-50">
        <button onclick="window.history.back()" class="w-10 h-10 flex items-center justify-center rounded-2xl bg-white/5 hover:bg-white/10 transition-all">
            <i class="fas fa-arrow-right text-white"></i>
        </button>
        <h1 class="text-xl font-bold flex-1">Ø§ÙƒÙ…Ø§Ù„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø´Ø±Ø§Ø¡</h1>
        <div id="user-email-badge" class="user-email-badge hidden">
            <i class="fas fa-user"></i>
            <span id="user-email-display">user@email.com</span>
        </div>
    </header>

    <!-- Main Content -->
    <main class="p-4 max-w-md mx-auto pb-20" id="main-content">
        <!-- Automatic Check Section (Initially Hidden) -->
        <section id="section-auto-check" class="visible-section">
            <div class="glass rounded-2xl p-6 text-center">
                <div class="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-6"></div>
                <h2 class="text-xl font-bold mb-4">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø´Ø±Ø§Ø¡...</h2>
                <p class="text-gray-400">ÙŠØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„ÙƒØªØ§Ø¨</p>
            </div>
        </section>

        <!-- Step 1: Payment Method (Only shown if no previous state or state is 'no') -->
        <section id="section-payment-method" class="hidden-section">
            <div class="step-indicator">
                <div class="step active">
                    <div class="step-circle">1</div>
                    <div class="step-label">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</div>
                </div>
                <div class="step-line"></div>
                <div class="step pending">
                    <div class="step-circle">2</div>
                    <div class="step-label">Ø§Ù„ØªØ£ÙƒÙŠØ¯</div>
                </div>
            </div>

            <!-- Book Info -->
            <div class="glass rounded-2xl p-4 mb-4">
                <div class="flex items-start gap-3">
                    <img id="book-preview-image" src="" alt="" class="book-image-small">
                    <div class="flex-1">
                        <h3 class="font-bold text-lg" id="book-preview-title">Ø§Ø³Ù… Ø§Ù„ÙƒØªØ§Ø¨</h3>
                        <div class="flex items-center gap-2 mt-1">
                            <span class="text-gray-400 line-through" id="book-old-price">0 Ø¬Ù†ÙŠÙ‡</span>
                            <span class="font-bold text-green-400 text-lg" id="book-preview-price">0 Ø¬Ù†ÙŠÙ‡</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="glass rounded-2xl p-6 mb-4">
                <div class="mb-6">
                    <div class="user-email-badge mx-auto mb-4">
                        <i class="fas fa-envelope"></i>
                        <span id="current-user-email">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
                    </div>
                    <h2 class="text-xl font-bold text-center">Ø§Ø®ØªØ± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</h2>
                </div>
                
                <div class="space-y-4">
                    <!-- Ù…Ø­ÙØ¸Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ© -->
                    <div class="payment-method-card" onclick="selectPaymentMethod('wallet')" id="wallet-card">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-blue-600/20 rounded-xl flex items-center justify-center">
                                <i class="fas fa-wallet text-blue-500 text-xl"></i>
                            </div>
                            <div class="flex-1">
                                <h3 class="font-bold">Ù…Ø­ÙØ¸Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©</h3>
                                <p class="text-sm text-gray-400">ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´ - Ø£ÙˆØ±Ù†Ø¬ ÙƒØ§Ø´ - ÙˆØºÙŠØ±Ù‡Ø§</p>
                            </div>
                            <div class="w-6 h-6 rounded-full border-2 border-gray-400 payment-check"></div>
                        </div>
                    </div>

                    <!-- PayPal -->
                    <div class="payment-method-card" onclick="selectPaymentMethod('paypal')" id="paypal-card">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-blue-900/20 rounded-xl flex items-center justify-center">
                                <i class="fab fa-paypal text-blue-400 text-xl"></i>
                            </div>
                            <div class="flex-1">
                                <h3 class="font-bold">PayPal</h3>
                                <p class="text-sm text-gray-400">Ø§Ù„Ø¯ÙØ¹ Ø¹Ø¨Ø± Ø­Ø³Ø§Ø¨ PayPal</p>
                            </div>
                            <div class="w-6 h-6 rounded-full border-2 border-gray-400 payment-check"></div>
                        </div>
                    </div>
                </div>

                <!-- Wallet Number Input -->
                <div id="wallet-number-input" class="mt-6 hidden">
                    <label class="block text-sm text-gray-400 mb-2">Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø© Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©</label>
                    <input type="tel" id="wallet-number" 
                           class="w-full p-3 bg-white/5 border border-white/10 rounded-xl focus:outline-none focus:border-blue-500 transition-all"
                           placeholder="Ù…Ø«Ø§Ù„: 01012345678"
                           maxlength="11"
                           pattern="01[0-9]{9}">
                    <p class="text-xs text-gray-500 mt-1">Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø© Ø§Ù„ØªÙŠ Ø³ØªÙ‚ÙˆÙ… Ø¨Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù…Ù†Ù‡Ø§ (11 Ø±Ù‚Ù…)</p>
                </div>

                <!-- PayPal Account Input -->
                <div id="paypal-account-input" class="mt-6 hidden">
                    <label class="block text-sm text-gray-400 mb-2">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙÙŠ PayPal</label>
                    <input type="text" id="paypal-account" 
                           class="w-full p-3 bg-white/5 border border-white/10 rounded-xl focus:outline-none focus:border-blue-500 transition-all"
                           placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
                </div>

                <button onclick="proceedToPaymentInstructions()" 
                        class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-bold mt-8 transition-all"
                        id="proceed-btn" disabled>
                    Ø§Ù„ØªØ§Ù„ÙŠ
                </button>
            </div>
        </section>

        <!-- Step 2: Payment Instructions -->
        <section id="section-payment-instructions" class="hidden-section">
            <div class="step-indicator">
                <div class="step completed">
                    <div class="step-circle"><i class="fas fa-check"></i></div>
                    <div class="step-label">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</div>
                </div>
                <div class="step-line"></div>
                <div class="step active">
                    <div class="step-circle">2</div>
                    <div class="step-label">Ø§Ù„ØªØ£ÙƒÙŠØ¯</div>
                </div>
            </div>

            <div class="glass rounded-2xl p-6 mb-4">
                <h2 class="text-xl font-bold mb-6 text-center">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯ÙØ¹</h2>
                
                <!-- Book Info -->
                <div class="mb-6 p-4 bg-white/5 rounded-xl">
                    <div class="flex items-start gap-3">
                        <img id="book-image" src="" alt="" class="book-image-small">
                        <div class="flex-1">
                            <h3 class="font-bold" id="book-title">Ø§Ø³Ù… Ø§Ù„ÙƒØªØ§Ø¨</h3>
                            <div class="flex justify-between items-center mt-2">
                                <span class="text-gray-400">Ø§Ù„Ø³Ø¹Ø±:</span>
                                <span class="font-bold text-blue-400 text-lg" id="book-price">0 Ø¬Ù†ÙŠÙ‡</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- User Info -->
                <div class="mb-6">
                    <div class="payment-details-table">
                        <tr>
                            <td>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</td>
                            <td id="payment-user-email">user@email.com</td>
                        </tr>
                        <tr>
                            <td>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹:</td>
                            <td id="payment-method-display">Ù…Ø­ÙØ¸Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©</td>
                        </tr>
                        <tr id="wallet-details-row">
                            <td>Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø©:</td>
                            <td id="payment-wallet-number">010XXXXXXXX</td>
                        </tr>
                    </div>
                </div>

                <!-- Wallet Instructions -->
                <div id="wallet-instructions" class="payment-details">
                    <div class="payment-info-card">
                        <h3 class="font-bold mb-3">ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„ØªØ­ÙˆÙŠÙ„:</h3>
                        
                        <div class="space-y-4">
                            <div class="text-center">
                                <div class="text-sm text-gray-400 mb-2">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø°ÙŠ Ø³ÙŠØ±Ø³Ù„ <strong>Ù…Ù†Ù‡</strong></div>
                                <div class="payment-number text-lg">
                                    <span id="from-number">010XXXXXXXX</span>
                                    <button onclick="copyToClipboard('from')" class="copy-btn w-8 h-8 flex items-center justify-center bg-white/5 rounded-lg">
                                        <i class="fas fa-copy text-sm"></i>
                                    </button>
                                </div>
                            </div>

                            <div class="transfer-flow">
                                <div class="transfer-arrow"><i class="fas fa-long-arrow-alt-left fa-2x"></i></div>
                            </div>

                            <div class="text-center">
                                <div class="text-sm text-gray-400 mb-2">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø°ÙŠ Ø³ÙŠØ³ØªÙ‚Ø¨Ù„ <strong>(Ø«Ø§Ø¨Øª)</strong></div>
                                <div class="payment-number text-lg">
                                    <span id="to-number">01009341792</span>
                                    <button onclick="copyToClipboard('to')" class="copy-btn w-8 h-8 flex items-center justify-center bg-white/5 rounded-lg">
                                        <i class="fas fa-copy text-sm"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="mt-6 p-3 bg-blue-900/20 border border-blue-500/30 rounded-lg">
                            <p class="text-sm text-center">
                                <strong>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:</strong>
                                <span class="font-bold text-yellow-400 text-lg block mt-1" id="exact-amount">0 Ø¬Ù†ÙŠÙ‡</span>
                            </p>
                        </div>

                        <div class="mt-4 p-3 bg-yellow-900/20 border border-yellow-500/30 rounded-lg">
                            <p class="text-sm text-center">
                                <i class="fas fa-clock text-yellow-400 mr-2"></i>
                                <strong>Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± 15 Ø¯Ù‚ÙŠÙ‚Ø©</strong> Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
                            </p>
                        </div>
                    </div>
                </div>

                <!-- PayPal Instructions -->
                <div id="paypal-instructions" class="payment-details hidden">
                    <div class="payment-info-card">
                        <h3 class="font-bold mb-3">ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø¯ÙØ¹ Ø¹Ø¨Ø± PayPal:</h3>
                        
                        <div class="space-y-3">
                            <div>
                                <p class="text-sm text-gray-400 mb-2">Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø§Ø¨Ø· Ø£Ø¯Ù†Ø§Ù‡ Ù„Ù„Ø¯ÙØ¹ Ø¹Ø¨Ø± PayPal:</p>
                                <a href="https://paypal.me/eshope" 
                                   target="_blank"
                                   class="block p-3 bg-blue-900/20 border border-blue-500/30 rounded-lg text-center hover:bg-blue-900/30 transition-all">
                                    <i class="fab fa-paypal mr-2"></i>
                                    Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„Ù„Ø¯ÙØ¹ Ø¹Ø¨Ø± PayPal
                                </a>
                            </div>

                            <div class="mt-4 p-3 bg-yellow-900/20 border border-yellow-500/30 rounded-lg">
                                <p class="text-sm text-center">
                                    <i class="fas fa-clock text-yellow-400 mr-2"></i>
                                    <strong>Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± 15 Ø¯Ù‚ÙŠÙ‚Ø©</strong> Ø¨Ø¹Ø¯ Ø§Ù„Ø¯ÙØ¹ Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Countdown Timer -->
                <div class="mb-6 text-center">
                    <div class="inline-flex items-center gap-2 px-4 py-2 bg-white/5 rounded-xl">
                        <i class="fas fa-clock text-blue-400"></i>
                        <span class="text-sm text-gray-400">Ù…ØªØ¨Ù‚ÙŠ Ù„Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©:</span>
                        <span id="countdown" class="countdown-timer">15:00</span>
                    </div>
                    <p class="text-xs text-gray-400 mt-2">Ø³ÙŠØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ÙˆÙ‚Øª</p>
                </div>

                <!-- Confirm Button -->
                <div class="space-y-3">
                    <button onclick="confirmPayment()" 
                            class="w-full py-3 bg-green-600 hover:bg-green-700 text-white rounded-xl font-bold transition-all">
                        <i class="fas fa-check-circle mr-2"></i>
                        Ù…ÙˆØ§ÙÙ‚ - Ù‚Ù…Øª Ø¨Ø§Ù„ØªØ­ÙˆÙŠÙ„
                    </button>
                    
                    <button onclick="backToPaymentMethod()" 
                            class="w-full py-3 bg-white/5 hover:bg-white/10 rounded-xl font-bold transition-all">
                        Ø±Ø¬ÙˆØ¹
                    </button>
                </div>
            </div>
        </section>

        <!-- Step 3: Order Status -->
        <section id="section-order-status" class="hidden-section">
            <div class="glass rounded-2xl p-6 mb-4">
                <!-- Current Order Status -->
                <div class="text-center mb-6">
                    <div id="status-icon" class="w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 border-4">
                        <i class="fas fa-clock text-3xl text-yellow-500"></i>
                    </div>
                    
                    <h2 id="status-title" class="text-xl font-bold mb-2">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</h2>
                    <p id="status-message" class="text-gray-400 mb-4">
                        ÙŠØªÙ… Ø­Ø§Ù„ÙŠØ§Ù‹ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ
                    </p>
                    
                    <div id="current-status-badge" class="inline-block">
                        <span class="status-badge status-tdd">
                            <i class="fas fa-clock"></i> Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© (tdd)
                        </span>
                    </div>
                </div>

                <!-- Book Details -->
                <div class="mb-6">
                    <h3 class="font-bold mb-4 border-b border-white/10 pb-2">ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙƒØªØ§Ø¨</h3>
                    <div class="flex items-start gap-3">
                        <img id="status-book-image" src="" alt="" class="book-image-small">
                        <div class="flex-1">
                            <h4 class="font-bold" id="status-book-title">Ø§Ø³Ù… Ø§Ù„ÙƒØªØ§Ø¨</h4>
                            <p class="text-sm text-gray-400 mb-2" id="status-book-description">ÙˆØµÙ Ø§Ù„ÙƒØªØ§Ø¨...</p>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-400">Ø§Ù„Ø³Ø¹Ø±:</span>
                                <span class="font-bold text-blue-400" id="status-book-price">0 Ø¬Ù†ÙŠÙ‡</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Statistics -->
                <div class="mb-6">
                    <h3 class="font-bold mb-4 border-b border-white/10 pb-2">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø´Ø±Ø§Ø¡ Ù„Ù‡Ø°Ø§ Ø§Ù„ÙƒØªØ§Ø¨</h3>
                    <div class="purchase-stats">
                        <div class="stat-item">
                            <div class="stat-value" id="status-total">0</div>
                            <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="status-ok">0</div>
                            <div class="stat-label">Ù†Ø¬Ø§Ø­</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="status-no">0</div>
                            <div class="stat-label">ÙØ´Ù„</div>
                        </div>
                    </div>
                </div>

                <!-- Payment Details -->
                <div class="mb-6">
                    <h3 class="font-bold mb-4 border-b border-white/10 pb-2">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯ÙØ¹</h3>
                    <div class="payment-details-table">
                        <tr>
                            <td>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨:</td>
                            <td id="status-order-id" class="font-mono">-</td>
                        </tr>
                        <tr>
                            <td>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</td>
                            <td id="status-email">-</td>
                        </tr>
                        <tr>
                            <td>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹:</td>
                            <td id="status-payment-method">-</td>
                        </tr>
                        <tr>
                            <td>Ø§Ù„ØªØ§Ø±ÙŠØ®:</td>
                            <td id="status-date">-</td>
                        </tr>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div id="action-buttons" class="space-y-3">
                    <button onclick="checkOrderStatus()" 
                            class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-bold transition-all">
                        <i class="fas fa-sync-alt mr-2"></i>
                        ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©
                    </button>
                </div>
            </div>
        </section>

        <!-- Download Section (When status is ok) -->
        <section id="section-download" class="hidden-section">
            <div class="glass rounded-2xl p-6 text-center">
                <div class="w-20 h-20 bg-green-600/20 rounded-full flex items-center justify-center mx-auto mb-6 border-4 border-green-500/30">
                    <i class="fas fa-check-circle text-green-500 text-3xl"></i>
                </div>
                
                <h2 class="text-xl font-bold mb-4">ØªÙ… Ø§Ù„Ø¯ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­! ğŸ‰</h2>
                <p class="text-gray-400 mb-6">ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø·Ù„Ø¨Ùƒ. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒØªØ§Ø¨.</p>
                
                <a id="download-link" href="#" target="_blank" 
                   class="block w-full py-3 bg-green-600 hover:bg-green-700 text-white rounded-xl font-bold mb-4 transition-all">
                    <i class="fas fa-download mr-2"></i>
                    ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒØªØ§Ø¨
                </a>

                <!-- Statistics -->
                <div class="mb-6">
                    <h3 class="font-bold mb-4">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø´Ø±Ø§Ø¡ Ù„Ù‡Ø°Ø§ Ø§Ù„ÙƒØªØ§Ø¨</h3>
                    <div class="purchase-stats">
                        <div class="stat-item">
                            <div class="stat-value" id="download-total">0</div>
                            <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="download-ok">0</div>
                            <div class="stat-label">Ù†Ø¬Ø§Ø­</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="download-no">0</div>
                            <div class="stat-label">ÙØ´Ù„</div>
                        </div>
                    </div>
                </div>
                
                <button onclick="window.location.href='data.html'" 
                        class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-bold">
                    Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙƒØªØ¨Ø©
                </button>
            </div>
        </section>

        <!-- Retry Section (When status is no) -->
        <section id="section-retry" class="hidden-section">
            <div class="glass rounded-2xl p-6 text-center">
                <div class="w-20 h-20 bg-red-600/20 rounded-full flex items-center justify-center mx-auto mb-6 border-4 border-red-500/30">
                    <i class="fas fa-times-circle text-red-500 text-3xl"></i>
                </div>
                
                <h2 class="text-xl font-bold mb-4">ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø¯ÙØ¹</h2>
                <p class="text-gray-400 mb-6">Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯ÙØ¹. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.</p>

                <!-- Statistics -->
                <div class="mb-6">
                    <h3 class="font-bold mb-4">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø´Ø±Ø§Ø¡ Ù„Ù‡Ø°Ø§ Ø§Ù„ÙƒØªØ§Ø¨</h3>
                    <div class="purchase-stats">
                        <div class="stat-item">
                            <div class="stat-value" id="retry-total">0</div>
                            <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="retry-ok">0</div>
                            <div class="stat-label">Ù†Ø¬Ø§Ø­</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="retry-no">0</div>
                            <div class="stat-label">ÙØ´Ù„</div>
                        </div>
                    </div>
                </div>
                
                <div class="space-y-3">
                    <button onclick="retryPurchase()" 
                            class="w-full py-3 bg-red-600 hover:bg-red-700 text-white rounded-xl font-bold">
                        <i class="fas fa-redo-alt mr-2"></i>
                        Ø´Ø±Ø§Ø¡ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
                    </button>
                    
                    <button onclick="window.location.href='data.html'" 
                            class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-bold">
                        Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙƒØªØ¨Ø©
                    </button>
                </div>
            </div>
        </section>
    </main>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 hidden">
        <div class="text-center">
            <div class="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
            <p class="text-white">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...</p>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA4efVo2ak3jhTslz-jFvHAkhEt-t9SVOQ",
            authDomain: "e-shop-aa5ea.firebasestorage.app",
            databaseURL: "https://e-shop-aa5ea-default-rtdb.firebaseio.com",
            projectId: "e-shop-aa5ea",
            storageBucket: "e-shop-aa5ea.firebasestorage.app",
            messagingSenderId: "751567638938",
            appId: "1:751567638938:android:63555c7081ec50c6dcaa23"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Global Variables
        let currentBook = null;
        let currentBookId = null;
        let currentBookPrice = null;
        let orderId = null;
        let countdownInterval = null;
        let timeLeft = 15 * 60;
        let selectedPaymentMethod = null;
        let userEmail = null;
        let userAccount = null;
        let orderKey = null;
        let userIdentifier = null;
        let currentOrder = null;

        // Initialize Page
        document.addEventListener('DOMContentLoaded', () => {
            // Get book ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            currentBookId = urlParams.get('book');
            
            if (!currentBookId) {
                showError('Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ ÙƒØªØ§Ø¨!');
                setTimeout(() => window.location.href = 'data.html', 2000);
                return;
            }
            
            // Load book details first
            loadBookDetails();
        });

        // Load Book Details from Firebase
        function loadBookDetails() {
            showLoading(true);
            
            const bookRef = database.ref(`books/${currentBookId}`);
            bookRef.once('value')
                .then(snapshot => {
                    if (snapshot.exists()) {
                        currentBook = snapshot.val();
                        currentBookPrice = currentBook.priceReal || currentBook.price || 0;
                        
                        // Update UI with book details
                        updateBookDetails();
                        
                        // Now check user state
                        checkUserState();
                    } else {
                        showLoading(false);
                        showError('Ø§Ù„ÙƒØªØ§Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!');
                        setTimeout(() => window.location.href = 'data.html', 2000);
                    }
                })
                .catch(error => {
                    showLoading(false);
                    showError('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒØªØ§Ø¨');
                    console.error('Error loading book:', error);
                });
        }

        // Check User State
        function checkUserState() {
            // Get user email from localStorage or generate unique one
            let storedEmail = localStorage.getItem('eshop_user_email');
            
            if (!storedEmail) {
                // Generate unique email for this user
                storedEmail = generateUserEmail();
                localStorage.setItem('eshop_user_email', storedEmail);
            }
            
            userEmail = storedEmail;
            userIdentifier = btoa(userEmail + '_' + currentBookId).replace(/=/g, '');
            
            // Update UI with user email
            updateUserEmailUI();
            
            // Check for existing orders
            checkExistingOrders();
        }

        // Generate Unique User Email
        function generateUserEmail() {
            const timestamp = Date.now();
            const random = Math.random().toString(36).substring(2, 10);
            return `user_${random}_${timestamp}@eshope.com`;
        }

        // Update User Email in UI
        function updateUserEmailUI() {
            document.getElementById('current-user-email').textContent = userEmail;
            document.getElementById('user-email-display').textContent = userEmail;
            document.getElementById('payment-user-email').textContent = userEmail;
            document.getElementById('user-email-badge').classList.remove('hidden');
        }

        // Check Existing Orders
        function checkExistingOrders() {
            const ordersRef = database.ref(`orders/${userIdentifier}`);
            
            ordersRef.orderByChild('timestamp').once('value')
                .then(snapshot => {
                    showLoading(false);
                    
                    if (snapshot.exists()) {
                        const orders = snapshot.val();
                        const orderKeys = Object.keys(orders);
                        
                        // Get the latest order
                        let latestOrder = null;
                        let latestKey = null;
                        
                        orderKeys.forEach(key => {
                            const order = orders[key];
                            if (!latestOrder || order.timestamp > latestOrder.timestamp) {
                                latestOrder = order;
                                latestKey = key;
                            }
                        });
                        
                        if (latestOrder) {
                            currentOrder = latestOrder;
                            orderKey = latestKey;
                            orderId = latestOrder.orderId;
                            selectedPaymentMethod = latestOrder.paymentMethod;
                            userAccount = latestOrder.account;
                            
                            // Handle based on state
                            handleStateBasedOnOrder(latestOrder.state);
                        } else {
                            // No orders found, show payment method selection
                            showSection('section-payment-method');
                        }
                    } else {
                        // No orders found, show payment method selection
                        showSection('section-payment-method');
                    }
                    
                    // Load statistics in all cases
                    loadStatistics();
                })
                .catch(error => {
                    showLoading(false);
                    console.error('Error checking existing orders:', error);
                    showSection('section-payment-method');
                });
        }

        // Handle State Based on Order
        function handleStateBasedOnOrder(state) {
            switch(state) {
                case 'ok':
                    // Show download section
                    showSection('section-download');
                    // Start monitoring for changes (in case admin changes state)
                    monitorOrderStatus();
                    break;
                    
                case 'no':
                    // Show retry section
                    showSection('section-retry');
                    break;
                    
                case 'tdd':
                    // Show order status section
                    showSection('section-order-status');
                    // Start monitoring
                    monitorOrderStatus();
                    break;
                    
                default:
                    // Show payment method selection
                    showSection('section-payment-method');
            }
        }

        // Monitor Order Status Changes
        function monitorOrderStatus() {
            if (!userIdentifier || !orderKey) return;
            
            const orderRef = database.ref(`orders/${userIdentifier}/${orderKey}/state`);
            
            orderRef.on('value', (snapshot) => {
                if (snapshot.exists()) {
                    const state = snapshot.val();
                    handleStateBasedOnOrder(state);
                    
                    // Update statistics when state changes
                    loadStatistics();
                }
            });
        }

        // Load Statistics
        function loadStatistics() {
            if (!userIdentifier) return;
            
            const ordersRef = database.ref(`orders/${userIdentifier}`);
            
            ordersRef.once('value')
                .then(snapshot => {
                    if (snapshot.exists()) {
                        const orders = snapshot.val();
                        let total = 0;
                        let okCount = 0;
                        let noCount = 0;
                        let tddCount = 0;
                        
                        Object.values(orders).forEach(order => {
                            total++;
                            if (order.state === 'ok') okCount++;
                            if (order.state === 'no') noCount++;
                            if (order.state === 'tdd') tddCount++;
                        });
                        
                        // Update statistics in all sections
                        updateStatisticsInSections(total, okCount, noCount, tddCount);
                    } else {
                        updateStatisticsInSections(0, 0, 0, 0);
                    }
                })
                .catch(error => {
                    console.error('Error loading statistics:', error);
                });
        }

        // Update Statistics in All Sections
        function updateStatisticsInSections(total, ok, no, tdd) {
            // Status section
            document.getElementById('status-total').textContent = total;
            document.getElementById('status-ok').textContent = ok;
            document.getElementById('status-no').textContent = no;
            
            // Download section
            document.getElementById('download-total').textContent = total;
            document.getElementById('download-ok').textContent = ok;
            document.getElementById('download-no').textContent = no;
            
            // Retry section
            document.getElementById('retry-total').textContent = total;
            document.getElementById('retry-ok').textContent = ok;
            document.getElementById('retry-no').textContent = no;
        }

        // Update Book Details in UI
        function updateBookDetails() {
            // Book info in preview
            const bookTitle = currentBook.name || 'ÙƒØªØ§Ø¨';
            const bookDescription = currentBook.dec || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ Ù…ØªØ§Ø­';
            
            document.getElementById('book-preview-title').textContent = bookTitle;
            document.getElementById('book-preview-price').textContent = formatPrice(currentBookPrice);
            document.getElementById('book-title').textContent = bookTitle;
            document.getElementById('book-price').textContent = formatPrice(currentBookPrice);
            document.getElementById('exact-amount').textContent = formatPrice(currentBookPrice);
            
            // Set book images
            const bookImages = [
                'book-preview-image',
                'book-image', 
                'status-book-image'
            ];
            
            bookImages.forEach(id => {
                const img = document.getElementById(id);
                if (currentBook.img1) {
                    img.src = currentBook.img1;
                } else {
                    img.src = 'https://images.unsplash.com/photo-1544716278-ca5e3f4abd8c?ixlib=rb-4.0.3&auto=format&fit=crop&w=200&q=80';
                }
            });
            
            // Update other sections
            document.getElementById('status-book-title').textContent = bookTitle;
            document.getElementById('status-book-description').textContent = bookDescription;
            document.getElementById('status-book-price').textContent = formatPrice(currentBookPrice);
            
            // Show old price if available
            if (currentBook.price && currentBook.priceReal) {
                document.getElementById('book-old-price').textContent = formatPrice(currentBook.price);
            }
            
            // Update download link if available
            if (currentBook.download) {
                const downloadLink = document.getElementById('download-link');
                downloadLink.href = currentBook.download;
            }
        }

        // Select Payment Method
        function selectPaymentMethod(method) {
            selectedPaymentMethod = method;
            
            // Update UI
            document.querySelectorAll('.payment-method-card').forEach(card => {
                card.classList.remove('selected');
                const check = card.querySelector('.payment-check');
                check.style.background = 'transparent';
                check.style.borderColor = '#666';
            });
            
            const selectedCard = document.getElementById(`${method}-card`);
            selectedCard.classList.add('selected');
            const check = selectedCard.querySelector('.payment-check');
            check.style.background = '#0066cc';
            check.style.borderColor = '#0066cc';
            check.innerHTML = '<i class="fas fa-check text-white text-xs"></i>';
            
            // Show/hide input fields
            if (method === 'wallet') {
                document.getElementById('wallet-number-input').classList.remove('hidden');
                document.getElementById('paypal-account-input').classList.add('hidden');
            } else {
                document.getElementById('wallet-number-input').classList.add('hidden');
                document.getElementById('paypal-account-input').classList.remove('hidden');
            }
            
            // Enable proceed button
            document.getElementById('proceed-btn').disabled = false;
        }

        // Proceed to Payment Instructions
        function proceedToPaymentInstructions() {
            if (!selectedPaymentMethod) {
                showError('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹');
                return;
            }
            
            // Validate inputs
            let isValid = true;
            
            if (selectedPaymentMethod === 'wallet') {
                const walletNumber = document.getElementById('wallet-number').value.trim();
                
                if (!walletNumber) {
                    showError('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø©');
                    isValid = false;
                }
                
                // Validate wallet number
                const phoneRegex = /^01[0-9]{9}$/;
                if (!phoneRegex.test(walletNumber)) {
                    showError('Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø© ØºÙŠØ± ØµØ­ÙŠØ­. ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 11 Ø±Ù‚Ù… ÙˆÙŠØ¨Ø¯Ø£ Ø¨Ù€ 01');
                    isValid = false;
                }
                
                if (isValid) {
                    userAccount = walletNumber;
                }
            } else {
                const paypalAccount = document.getElementById('paypal-account').value.trim();
                
                if (!paypalAccount) {
                    showError('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ');
                    isValid = false;
                }
                
                if (isValid) {
                    userAccount = paypalAccount;
                }
            }
            
            if (!isValid) return;
            
            // Update payment details
            document.getElementById('payment-method-display').textContent = 
                selectedPaymentMethod === 'wallet' ? 'Ù…Ø­ÙØ¸Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©' : 'PayPal';
            
            if (selectedPaymentMethod === 'wallet') {
                document.getElementById('payment-wallet-number').textContent = userAccount;
                document.getElementById('wallet-details-row').classList.remove('hidden');
                document.getElementById('from-number').textContent = userAccount;
            } else {
                document.getElementById('wallet-details-row').classList.add('hidden');
            }
            
            // Show payment instructions
            showSection('section-payment-instructions');
            
            // Update instructions based on payment method
            if (selectedPaymentMethod === 'wallet') {
                document.getElementById('wallet-instructions').classList.remove('hidden');
                document.getElementById('paypal-instructions').classList.add('hidden');
            } else {
                document.getElementById('wallet-instructions').classList.add('hidden');
                document.getElementById('paypal-instructions').classList.remove('hidden');
            }
            
            // Start countdown
            startCountdown();
        }

        // Start Countdown Timer
        function startCountdown() {
            const countdownElement = document.getElementById('countdown');
            timeLeft = 15 * 60;
            
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }
            
            countdownInterval = setInterval(() => {
                timeLeft--;
                
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                
                countdownElement.textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                if (timeLeft <= 0) {
                    clearInterval(countdownInterval);
                    showError('Ø§Ù†ØªÙ‡Ù‰ ÙˆÙ‚Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ©!');
                    setTimeout(() => {
                        window.location.href = 'data.html';
                    }, 3000);
                }
            }, 1000);
        }

        // Copy to Clipboard
        function copyToClipboard(type) {
            let text = '';
            
            if (type === 'from') {
                text = document.getElementById('from-number').textContent;
            } else if (type === 'to') {
                text = '01009341792';
            }
            
            navigator.clipboard.writeText(text)
                .then(() => {
                    const btn = event.currentTarget;
                    const icon = btn.querySelector('i');
                    
                    // Change icon
                    icon.className = 'fas fa-check';
                    btn.classList.add('copied');
                    
                    showNotification('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ù‚Ù… Ø¨Ù†Ø¬Ø§Ø­', 'success');
                    
                    setTimeout(() => {
                        icon.className = 'fas fa-copy';
                        btn.classList.remove('copied');
                    }, 2000);
                })
                .catch(err => {
                    console.error('Failed to copy:', err);
                    showNotification('ÙØ´Ù„ ÙÙŠ Ø§Ù„Ù†Ø³Ø®', 'error');
                });
        }

        // Confirm Payment and Save Order
        function confirmPayment() {
            showLoading(true);
            
            // Generate order ID
            orderId = 'ORD-' + Date.now();
            orderKey = Date.now().toString();
            
            // Prepare order data
            const orderData = {
                email: userEmail,
                state: "tdd", // Default state
                paymentMethod: selectedPaymentMethod,
                account: userAccount,
                bookId: currentBookId,
                bookName: currentBook.name || 'ÙƒØªØ§Ø¨',
                bookPrice: currentBookPrice,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                timestampReadable: new Date().toLocaleString('ar-SA'),
                orderId: orderId
            };
            
            // Save to Firebase
            const ordersRef = database.ref(`orders/${userIdentifier}/${orderKey}`);
            
            ordersRef.set(orderData)
                .then(() => {
                    showLoading(false);
                    
                    // Stop countdown
                    if (countdownInterval) {
                        clearInterval(countdownInterval);
                    }
                    
                    // Update order details in status section
                    document.getElementById('status-order-id').textContent = orderId;
                    document.getElementById('status-email').textContent = userEmail;
                    document.getElementById('status-payment-method').textContent = 
                        selectedPaymentMethod === 'wallet' ? 'Ù…Ø­ÙØ¸Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©' : 'PayPal';
                    document.getElementById('status-date').textContent = new Date().toLocaleString('ar-SA');
                    
                    // Show order status section
                    showSection('section-order-status');
                    
                    // Start monitoring order status
                    monitorOrderStatus();
                    
                    // Load updated statistics
                    loadStatistics();
                })
                .catch(error => {
                    showLoading(false);
                    showError('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨');
                    console.error('Error saving order:', error);
                });
        }

        // Navigation Functions
        function showSection(sectionId) {
            // Hide all sections except auto-check
            const sectionsToHide = [
                'section-payment-method',
                'section-payment-instructions',
                'section-order-status',
                'section-download',
                'section-retry',
                'section-auto-check'
            ];
            
            sectionsToHide.forEach(id => {
                const section = document.getElementById(id);
                if (section) {
                    section.classList.remove('visible-section');
                    section.classList.add('hidden-section');
                }
            });
            
            // Show target section
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.remove('hidden-section');
                targetSection.classList.add('visible-section');
            }
            
            // Scroll to top
            window.scrollTo(0, 0);
        }

        function backToPaymentMethod() {
            showSection('section-payment-method');
        }

        // Action Functions
        function checkOrderStatus() {
            showLoading(true);
            
            setTimeout(() => {
                showLoading(false);
                showNotification('Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨...', 'info');
            }, 1000);
        }

        function retryPurchase() {
            // Show payment method section for retry
            showSection('section-payment-method');
        }

        // Helper Functions
        function formatPrice(price) {
            if (!price && price !== 0) return '0 Ø¬Ù†ÙŠÙ‡';
            const num = parseInt(price);
            if (isNaN(num)) return price;
            return num.toLocaleString('ar-SA') + ' Ø¬Ù†ÙŠÙ‡';
        }

        function showLoading(show) {
            const overlay = document.getElementById('loading-overlay');
            overlay.classList.toggle('hidden', !show);
        }

        function showNotification(message, type = 'info') {
            document.querySelectorAll('.notification').forEach(n => n.remove());
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-${type === 'error' ? 'exclamation-circle' : type === 'success' ? 'check-circle' : 'info-circle'}"></i>
                        <span>${message}</span>
                    </div>
                    <button onclick="this.parentElement.parentElement.classList.add('fade-out')" 
                            class="text-white/70 hover:text-white ml-4">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.classList.add('fade-out');
                    setTimeout(() => {
                        if (notification.parentElement) {
                            notification.remove();
                        }
                    }, 300);
                }
            }, 5000);
        }

        function showError(message) {
            showNotification(message, 'error');
        }
    </script>
</body>
</html>
